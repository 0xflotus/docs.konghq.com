<!DOCTYPE html> <html lang="en" itemscope itemtype="http://schema.org/Article"> <head> <meta charset="utf-8"> <title>Plugins - OAuth 2.0 Authentication | Kong - Open-Source API and Microservice Management Layer</title> <meta name="description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more."> <meta name="author" content="Mashape"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="google-site-verification" content="7me2nZm-wWgDM4uoD1sJ18amVbNSpsbLR0ll8OG6b_A"> <link rel="stylesheet" href="//cloud.typography.com/7506032/804186/css/fonts.css"> <link rel="stylesheet" href="/assets/styles.css?v=2015-07-21-03-32-59"> <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"> <meta property="fb:admins" content="227304446"> <meta property="fb:admins" content="576641408"> <meta property="og:title" content="Kong - Open-Source API Management Layer"> <meta property="og:site_name" content="Kong - Open-Source API Management Layer"> <meta property="og:url" content="http://getkong.org"> <meta property="og:description" content="Open Source API Management and Microservice Management Platform with plugins for API authentication, logging, rate-limiting, transformations and more."> <meta property="og:type" content="website"> <meta property="og:locale" content="en_US"> <meta property="og:image" content="http://getkong.org/assets/images/share.png"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@mashape"> <meta name="twitter:creator" content="@mashape"> <meta name="twitter:url" content="http://getkong.org"> <script type="application/ld+json">{
      "@context": "http://schema.org",
      "@type": "Organization",
      "name": "Mashape",
      "url": "http://getkong.org/",
      "logo": "http://getkong.org/assets/images/logo.png",
      "sameAs": [
        "https://www.facebook.com/Mashape",
        "https://twitter.com/mashape",
        "https://plus.google.com/+mashape"
      ]
    }</script> </head> <body id="page-plugin"> <div class="navbar"> <div class="container"> <a href="/" class="navbar-brand"><img src="/assets/images/branding.svg" alt="Kong" width="99" height="32"></a> <iframe class="header-star" src="https://ghbtns.com/github-btn.html?user=Mashape&repo=kong&type=star" frameborder="0" scrolling="0" width="55" height="20"></iframe> <button data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar" class="navbar-toggle"> <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button> <nav id="navbar" class="navbar-nav"> <ul> <li><a href="/about/">About</a></li> <li><a href="/docs/">Docs</a></li> <li><a href="/plugins">Plugins</a></li> <li><a href="/community">Community</a></li> <li><a href="/enterprise">Enterprise Demo</a></li> <li><a href="https://github.com/Mashape/kong" target="_blank">GitHub</a></li> <li> <a href="/download" class="button button-dark" data-analytics="{&quot;event&quot;: &quot;Clicked download&quot;, &quot;type&quot;: &quot;button&quot;, &quot;location&quot;: &quot;header&quot;}">Installation</a> </li> </ul> </nav> </div> </div> <div class="page page-plugin"> <header class="page-header"> <div class="container"> <div class="page-header-icon"> <img src="/assets/images/icons/plugins/oauth2-authentication.png" alt=""> </div> <div class="page-header-title"> <ul class="breadcrumbs"> <li class="breadcrumb-item"><a href="/plugins">Plugins</a></li> </ul> <h1>OAuth 2.0 Authentication</h1> </div> <div class="page-header-right"> <a class="page-header-btn" href="https://github.com/Mashape/kong/issues/new" target="_blank">Report Bug</a> </div> </div> </header> <div class="container"> <div class="content"> <p>Add an OAuth 2.0 authentication layer with the <a href="https://tools.ietf.org/html/rfc6749#section-4.1">Authorization Code Grant</a> or <a href="https://tools.ietf.org/html/rfc6749#section-4.2">Implicit Grant</a> flow. This plugin <strong>requires</strong> the <a href="/plugins/ssl/">SSL Plugin</a> with the <code>only_https</code> parameter set to <code>true</code> to be already installed on the API, failing to do so will result in a security weakness.</p> <hr> <h2 id="installation">Installation</h2> <p>Add the plugin to the list of available plugins on every Kong server in your cluster by editing the <a href="/docs/0.4.0/configuration">kong.yml</a> configuration file:</p> <div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">plugins_available</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oauth2</span>
</code></pre></div> <p>Every node in the Kong cluster should have the same <code>plugins_available</code> property value.</p> <h2 id="configuration">Configuration</h2> <p>Configuring the plugin is straightforward, you can add it on top of an <a href="/docs/0.4.0/admin-api/#api-object">API</a> (or <a href="/docs/0.4.0/admin-api/#consumer-object">Consumer</a>) by executing the following request on your Kong server:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -X POST http://kong:8001/apis/<span class="o">{</span>api<span class="o">}</span>/plugins <span class="se">\</span>
    --data <span class="s2">&quot;name=oauth2&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;value.scopes=email,phone,address&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;value.mandatory_scope=true&quot;</span>
</code></pre></div> <p><code>api</code>: The <code>id</code> or <code>name</code> of the API that this plugin configuration will target</p> <table><thead> <tr> <th>form parameter</th> <th>description</th> </tr> </thead><tbody> <tr> <td><code>name</code></td> <td>The name of the plugin to use, in this case: <code>oauth2</code></td> </tr> <tr> <td><code>consumer_id</code><br><em>optional</em></td> <td>The CONSUMER ID that this plugin configuration will target. This value can only be used if <a href="/docs/0.4.0/faq/#how-can-i-add-an-authentication-layer-on-a-microservice/api?">authentication has been enabled</a> so that the system can identify the user making the request.</td> </tr> <tr> <td><code>value.scopes</code></td> <td>Describes an array of comma separated scope names that will be available to the end user</td> </tr> <tr> <td><code>value.mandatory_scope</code><br><em>optional</em></td> <td>Default <code>false</code>. An optional boolean value telling the plugin to require at least one scope to be authorized by the end user</td> </tr> <tr> <td><code>value.token_expiration</code><br><em>optional</em></td> <td>Default <code>7200</code>. An optional integer value telling the plugin how long should a token last, after which the client will need to refresh the token. Set to <code>0</code> to disable the expiration.</td> </tr> <tr> <td><code>value.enable_implicit_grant</code><br><em>optional</em></td> <td>Default <code>false</code>. An optional boolean value to enable the implicit grant flow which allows to provision a token as a result of the authorization process (<a href="https://tools.ietf.org/html/rfc6749#section-4.2">RFC 6742 Section 4.2</a>)</td> </tr> <tr> <td><code>value.hide_credentials</code><br><em>optional</em></td> <td>Default <code>false</code>. An optional boolean value telling the plugin to hide the credential to the upstream API server. It will be removed by Kong before proxying the request</td> </tr> </tbody></table> <h2 id="usage">Usage</h2> <p>In order to use the plugin, you first need to create a consumer to associate one or more credentials to. The Consumer represents a developer using the final service/API.</p> <h3 id="create-a-consumer">Create a Consumer</h3> <p>You need to associate a credential to an existing <a href="/docs/0.4.0/admin-api/#consumer-object">Consumer</a> object, that represents a user consuming the API. To create a <a href="/docs/0.4.0/admin-api/#consumer-object">Consumer</a> you can execute the following request:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -X POST http://kong:8001/consumers/ <span class="se">\</span>
    --data <span class="s2">&quot;username=user123&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;custom_id=SOME_CUSTOM_ID&quot;</span>
</code></pre></div> <table><thead> <tr> <th>parameter</th> <th>description</th> </tr> </thead><tbody> <tr> <td><code>username</code><br><em>semi-optional</em></td> <td>The username of the consumer. Either this field or <code>custom_id</code> must be specified.</td> </tr> <tr> <td><code>custom_id</code><br><em>semi-optional</em></td> <td>A custom identifier used to map the consumer to another database. Either this field or <code>username</code> must be specified.</td> </tr> </tbody></table> <p>A <a href="/docs/0.4.0/admin-api/#consumer-object">Consumer</a> can have many credentials.</p> <h3 id="create-an-oauth-2.0-authentication-credential/application">Create an OAuth 2.0 Authentication credential/application</h3> <p>Then you can finally provision new OAuth 2.0 credentials (also called &quot;OAuth applications&quot;) by making the following HTTP request:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl -X POST http://kong:8001/consumers/<span class="o">{</span>consumer_id<span class="o">}</span>/oauth2 <span class="se">\</span>
    --data <span class="s2">&quot;name=Test%20Application&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;client_id=SOME-CLIENT-ID&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;client_secret=SOME-CLIENT-SECRET&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;redirect_uri=http://some-domain/endpoint/&quot;</span>
</code></pre></div> <p><code>consumer_id</code>: The <a href="/docs/0.4.0/admin-api/#consumer-object">Consumer</a> entity to associate the credentials to</p> <table><thead> <tr> <th>form parameter</th> <th>description</th> </tr> </thead><tbody> <tr> <td><code>name</code></td> <td>The name to associate to the credential. In OAuth 2.0 this would be the application name.</td> </tr> <tr> <td><code>client_id</code><br><em>optional</em></td> <td>You can optionally set your own unique <code>client_id</code>. If missing, the plugin will generate one.</td> </tr> <tr> <td><code>client_secret</code><br><em>optional</em></td> <td>You can optionally set your own unique <code>client_secret</code>. If missing, the plugin will generate one.</td> </tr> <tr> <td><code>redirect_uri</code></td> <td>The URL in your app where users will be sent after authorization (<a href="https://tools.ietf.org/html/rfc6749#section-3.1.2">RFC 6742 Section 3.1.2</a>)</td> </tr> </tbody></table> <h3 id="implementing-the-authorization-page">Implementing the authorization page</h3> <p>After provisioning Consumers and associating OAuth 2.0 credentials to them, it is important to understand how the OAuth 2.0 authorization flow works. As opposed to most of the Kong plugins, the OAuth 2.0 plugin requires some little additional work on your side to make everything work well:</p> <ul> <li>You <strong>must</strong> implement an authorization page on your web application, that will talk with the plugin server-side.</li> <li><em>Optionally</em> you need to explain on your website/documentation how to consume your OAuth 2.0 protected services, so that developers accessing your service know how to build their client implementations</li> </ul> <h1 id="the-flow-explained">The flow explained</h1> <p>Building the authorization page is going to be the primary task that the plugin itself cannot do out of the box, because it requires to check that the user is properly logged in, and this operation is strongly tied with your authentication implementation.</p> <p>The authorization page is made of two parts:</p> <ul> <li>The frontend page that the user will see, and that will allow him to authorize the client application to access his data</li> <li>The backend that will process the HTML form displayed in the frontend, that will talk with the OAuth 2.0 plugin on Kong, and that will ultimately redirect the user to a third party URL.</li> </ul> <div class="alert alert-warning"> <div class="container" style="text-align:center"> <a href="https://github.com/Mashape/kong-oauth2-hello-world">You can see a sample implementation in node.js + express.js on GitHub</a> </div> </div> <p>Here is the flow:</p> <p><img src="/assets/images/docs/oauth2/oauth2-flow.png" alt="OAuth 2.0 Flow"></p> <p>1 - The client application will redirect the end user to the authorization page on your web application, passing <code>client_id</code>, <code>response_type</code> and <code>scope</code> (if required) as querystring parameters. This is a sample authorization page:</p> <p><img src="/assets/images/docs/oauth2/oauth2-prompt.png" alt="OAuth 2.0 Prompt"></p> <p>2 - Before showing the actual authorization page, the web application will make sure that the user is logged in.</p> <p>3 - The client application will send the <code>client_id</code> in the querystring, from which the web application can retrieve both the OAuth 2.0 application name, and developer name, by making the following request to Kong:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl kong:8001/oauth2?client_id<span class="o">=</span>XXX
</code></pre></div> <p>4 - If the end user authorized the application, the form will submit the data to your backend with a POST request, sending the <code>client_id</code>, <code>response_type</code> and <code>scope</code> parameters that were placed in <code>&lt;input type=&quot;hidden&quot; .. /&gt;</code> fields.</p> <p>5 - The backend must add the <code>provision_key</code> and <code>authenticated_userid</code> parameters to the <code>client_id</code>, <code>response_type</code> and <code>scope</code> parameters and it will make a POST request to Kong at your API address, on the <code>/oauth2/authorize</code> endpoint. The equivalent of:</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>curl https://your.api.com/oauth2/authorize
    --data <span class="s2">&quot;client_id=XXX&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;response_type=XXX&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;scope=XXX&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;provision_key=XXX&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;authenticated_username=XXX&quot;</span> <span class="se">\</span>
    --data <span class="s2">&quot;authenticated_userid=XXX&quot;</span>
</code></pre></div> <p>The <code>provision_key</code> is the key the plugin has generated when it has been added to the API, while <code>authenticated_userid</code> is the ID of the logged-in end user who has granted the permission.</p> <p>6 - Kong will respond with a JSON response like:</p> <div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;redirect_uri&quot;</span><span class="p">:</span> <span class="s2">&quot;http://some/url&quot;</span>
<span class="p">}</span>
</code></pre></div> <p>With either a <code>200 OK</code> or <code>400 Bad Request</code> response code depending if the request was successful or not.</p> <p>7 - In <strong>both</strong> cases, ignore the response status code and just redirect the user to whatever URI is being returned in the <code>redirect_uri</code> property.</p> <p>8 - The client appication will take it from here, and will continue the flow with Kong with no other interaction with your web application. Like exchaging the authorization code for an access token if it&#39;s an Authorization Code Grant flow.</p> <p>9 - Once the Access Token has been retrieved, the client application will make requests on behalf of the user to your final API.</p> <p>10 - Access Tokens can expire, and when that happens the client application needs to renew the Access Token with Kong and retreive a new one.</p> <p>In this flow, the steps that you need to implement are:</p> <ul> <li>The login page, you probably already have it (step 2)</li> <li>The Authorization page, with its backend that will simply collect the values, make a POST request to Kong and redirect the user to whatever URL Kong has returned (steps 3 to 7).</li> </ul> <h2 id="headers-sent-to-the-upstream-server">Headers sent to the upstream server</h2> <p>When a client has been authenticated and authorized, the plugin will append some headers to the request before proxying it to the upstream API/Microservice, so that you can identify the consumer and the end-user in your code:</p> <ul> <li><code>X-Consumer-ID</code>, the ID of the Consumer on Kong</li> <li><code>X-Consumer-Custom-ID</code>, the <code>custom_id</code> of to the Consumer (if set)</li> <li><code>X-Consumer-Username</code>, the <code>username</code> of to the Consumer (if set)</li> <li><code>X-Authenticated-Scope</code>, the comma-separated list of scopes that the end user has authenticated (if available)</li> <li><code>X-Authenticated-Userid</code>, the logged-in user ID who has granted permission to the client</li> </ul> <p>You can use this information on your side to implement additional logic. You can use the <code>X-Consumer-ID</code> value to query the Kong Admin API and retrieve more information about the Consumer.</p> </div> </div> </div> <footer class="footer"> <section class="section subscribe-section" id="newsletter"> <div class="container"> <header class="section-header"> <h4>Keep up with the latest features</h4> </header> <div class="loader"> <div class="loader-bounce1"></div> <div class="loader-bounce2"></div> <div class="loader-bounce3"></div> </div> <div class="form-message success-message">Thank you!</div> <div class="form-message error-message">Oops, something went wrong. Please try again later.</div> <form action="/" class="subscribe-form"> <input type="email" name="email" placeholder="youre@awesome.com" required> <button class="button button-primary" type="submit">Subscribe</button> </form> </div> </section> <div class="footer-bar"> <div class="container"> <ul class="footer-social"> <li> <a class="github-button" href="https://github.com/mashape/kong" data-icon="octicon-star" data-count-href="/mashape/kong/stargazers" data-count-api="/repos/mashape/kong#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star mashape/kong on GitHub">Star</a> </li> <li> <div class="fb-share-button" data-href="http://getkong.org/" data-layout="button_count"></div> </li> <li> <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://getkong.org" data-text="KONG - the open-source management layer for APIs and Microservices" data-hashtags="opensource,API,management">Tweet</a> </li> <li> <iframe src="http://c.yvoschaap.com/producthunt/counter.html#href=http://getkong.org&layout=wide" width="120" height="25" scrolling="no" frameborder="0" allowtransparency="true"></iframe> </li> </ul> <span> <a href="https://mashape.com"> <img src="/assets/images/branding-footer.svg" alt="Mashape" width="22" height="26"> &copy; <strong>2015 Mashape Inc</strong> </a> </span> <span class="footer-separator"></span> <span class="footer-nav"> <a href="/license">License</a> <a href="/terms">Terms</a> <a href="/privacy">Privacy</a> <a href="/enterprise">Enterprise</a> <a href="http://blog.mashape.com/category/open-source/" target="_blank">News</a> </span> </div> </div> </footer> <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script src="/assets/app.js?v=2015-07-21-03-32-59"></script><div id="fb-root"></div> <script id="github-bjs" src="https://buttons.github.io/buttons.js" async defer></script><script id="twitter-wjs" src="https://platform.twitter.com/widgets.js" async defer></script><script id="facebook-jssdk" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=842731852424506" async defer></script><script>var _vwo_code=function(){var e=125292,t=2e3,i=2500,n=!1,r=!1,o=document;return{use_existing_jquery:function(){return n},library_tolerance:function(){return i},finish:function(){if(!r){r=!0;var e=o.getElementById("_vis_opt_path_hides");e&&e.parentNode.removeChild(e)}},finished:function(){return r},load:function(e){var t=o.createElement("script");t.src=e,t.type="text/javascript",t.innerText,t.onerror=function(){_vwo_code.finish()},o.getElementsByTagName("head")[0].appendChild(t)},init:function(){settings_timer=setTimeout("_vwo_code.finish()",t),this.load("//dev.visualwebsiteoptimizer.com/j.php?a="+e+"&u="+encodeURIComponent(o.URL)+"&r="+Math.random());var i=o.createElement("style"),n="body{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}",r=o.getElementsByTagName("head")[0];return i.setAttribute("id","_vis_opt_path_hides"),i.setAttribute("type","text/css"),i.styleSheet?i.styleSheet.cssText=n:i.appendChild(o.createTextNode(n)),r.appendChild(i),settings_timer}}}();_vwo_settings_timer=_vwo_code.init();</script><script>!function(){var t=window.analytics=window.analytics||[];if(!t.initialize)if(t.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{t.invoked=!0,t.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"],t.factory=function(e){return function(){var n=Array.prototype.slice.call(arguments);return n.unshift(e),t.push(n),t}};for(var e=0;e<t.methods.length;e++){var n=t.methods[e];t[n]=t.factory(n)}t.load=function(t){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)},t.SNIPPET_VERSION="3.0.1",t.load("WDj0nSS7hpyxwL3evgbOzK755s0NUye6"),t.page()}}();</script></body></html>