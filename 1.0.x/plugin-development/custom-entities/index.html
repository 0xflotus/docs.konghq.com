<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Article">
  

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Plugin Development - Storing Custom Entities - v1.0.x | Kong - Open-Source API Management and Microservice Management</title>
  <meta name="description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more." />
  <meta name="author" content="KongHQ" />
  <meta property="og:title" content="Open-Source API Management and Microservice Management" />
  <meta property="og:site_name" content="Kong" />
  <!-- use share link for facebook -->
  <meta property="og:url" content="https://docs.konghq.com" />
  <meta property="og:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more." />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="en_US" />
  <meta
    property="og:image"
    content="https://docs.konghq.com/assets/images/share.png"
  />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@thekonginc" />
  <meta name="twitter:creator" content="@thekonginc" />
  <meta name="twitter:url" content="https://docs.konghq.com" />
  <meta name="twitter:description" content="Secure, Manage &amp; Extend your APIs or Microservices with plugins for authentication, logging, rate-limiting, transformations and more." />
  <meta
    name="twitter:image"
    content="https://docs.konghq.com/assets/images/share.png"
  />
  <meta property="fb:admins" content="227304446" />
  <meta property="fb:admins" content="576641408" />
  <meta
    name="google-site-verification"
    content="CrU3zp02dNKTe8NSAipL4NCPkrIjDXG8fViTZ-MIzP4"
  />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
    integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
    crossorigin="anonymous"
  />

  <!-- New Relic -->
  <script type="text/javascript">
/* eslint-disable */
window.NREUM||(NREUM={}),__nr_require=function(t,e,n){function r(n){if(!e[n]){var o=e[n]={exports:{}};t[n][0].call(o.exports,function(e){var o=t[n][1][e];return r(o||e)},o,o.exports)}return e[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t){try{c.console&&console.log(t)}catch(e){}}var o,i=t("ee"),a=t(20),c={};try{o=localStorage.getItem("__nr_flags").split(","),console&&"function"==typeof console.log&&(c.console=!0,o.indexOf("dev")!==-1&&(c.dev=!0),o.indexOf("nr_dev")!==-1&&(c.nrDev=!0))}catch(s){}c.nrDev&&i.on("internal-error",function(t){r(t.stack)}),c.dev&&i.on("fn-err",function(t,e,n){r(n.stack)}),c.dev&&(r("NR AGENT IN DEVELOPMENT MODE"),r("flags: "+a(c,function(t,e){return t}).join(", ")))},{}],2:[function(t,e,n){function r(t,e,n,r,c){try{h?h-=1:o(c||new UncaughtException(t,e,n),!0)}catch(f){try{i("ierr",[f,s.now(),!0])}catch(d){}}return"function"==typeof u&&u.apply(this,a(arguments))}function UncaughtException(t,e,n){this.message=t||"Uncaught error with no additional information",this.sourceURL=e,this.line=n}function o(t,e){var n=e?null:s.now();i("err",[t,n])}var i=t("handle"),a=t(21),c=t("ee"),s=t("loader"),f=t("gos"),u=window.onerror,d=!1,p="nr@seenError",h=0;s.features.err=!0,t(1),window.onerror=r;try{throw new Error}catch(l){"stack"in l&&(t(13),t(12),"addEventListener"in window&&t(6),s.xhrWrappable&&t(14),d=!0)}c.on("fn-start",function(t,e,n){d&&(h+=1)}),c.on("fn-err",function(t,e,n){d&&!n[p]&&(f(n,p,function(){return!0}),this.thrown=!0,o(n))}),c.on("fn-end",function(){d&&!this.thrown&&h>0&&(h-=1)}),c.on("internal-error",function(t){i("ierr",[t,s.now(),!0])})},{}],3:[function(t,e,n){t("loader").features.ins=!0},{}],4:[function(t,e,n){function r(){M++,S=y.hash,this[u]=b.now()}function o(){M--,y.hash!==S&&i(0,!0);var t=b.now();this[l]=~~this[l]+t-this[u],this[d]=t}function i(t,e){E.emit("newURL",[""+y,e])}function a(t,e){t.on(e,function(){this[e]=b.now()})}var c="-start",s="-end",f="-body",u="fn"+c,d="fn"+s,p="cb"+c,h="cb"+s,l="jsTime",m="fetch",v="addEventListener",w=window,y=w.location,b=t("loader");if(w[v]&&b.xhrWrappable){var g=t(10),x=t(11),E=t(8),P=t(6),O=t(13),R=t(7),T=t(14),L=t(9),j=t("ee"),N=j.get("tracer");t(15),b.features.spa=!0;var S,M=0;j.on(u,r),j.on(p,r),j.on(d,o),j.on(h,o),j.buffer([u,d,"xhr-done","xhr-resolved"]),P.buffer([u]),O.buffer(["setTimeout"+s,"clearTimeout"+c,u]),T.buffer([u,"new-xhr","send-xhr"+c]),R.buffer([m+c,m+"-done",m+f+c,m+f+s]),E.buffer(["newURL"]),g.buffer([u]),x.buffer(["propagate",p,h,"executor-err","resolve"+c]),N.buffer([u,"no-"+u]),L.buffer(["new-jsonp","cb-start","jsonp-error","jsonp-end"]),a(T,"send-xhr"+c),a(j,"xhr-resolved"),a(j,"xhr-done"),a(R,m+c),a(R,m+"-done"),a(L,"new-jsonp"),a(L,"jsonp-end"),a(L,"cb-start"),E.on("pushState-end",i),E.on("replaceState-end",i),w[v]("hashchange",i,!0),w[v]("load",i,!0),w[v]("popstate",function(){i(0,M>1)},!0)}},{}],5:[function(t,e,n){function r(t){}if(window.performance&&window.performance.timing&&window.performance.getEntriesByType){var o=t("ee"),i=t("handle"),a=t(13),c=t(12),s="learResourceTimings",f="addEventListener",u="resourcetimingbufferfull",d="bstResource",p="resource",h="-start",l="-end",m="fn"+h,v="fn"+l,w="bstTimer",y="pushState",b=t("loader");b.features.stn=!0,t(8);var g=NREUM.o.EV;o.on(m,function(t,e){var n=t[0];n instanceof g&&(this.bstStart=b.now())}),o.on(v,function(t,e){var n=t[0];n instanceof g&&i("bst",[n,e,this.bstStart,b.now()])}),a.on(m,function(t,e,n){this.bstStart=b.now(),this.bstType=n}),a.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),this.bstType])}),c.on(m,function(){this.bstStart=b.now()}),c.on(v,function(t,e){i(w,[e,this.bstStart,b.now(),"requestAnimationFrame"])}),o.on(y+h,function(t){this.time=b.now(),this.startPath=location.pathname+location.hash}),o.on(y+l,function(t){i("bstHist",[location.pathname+location.hash,this.startPath,this.time])}),f in window.performance&&(window.performance["c"+s]?window.performance[f](u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["c"+s]()},!1):window.performance[f]("webkit"+u,function(t){i(d,[window.performance.getEntriesByType(p)]),window.performance["webkitC"+s]()},!1)),document[f]("scroll",r,{passive:!0}),document[f]("keypress",r,!1),document[f]("click",r,!1)}},{}],6:[function(t,e,n){function r(t){for(var e=t;e&&!e.hasOwnProperty(u);)e=Object.getPrototypeOf(e);e&&o(e)}function o(t){c.inPlace(t,[u,d],"-",i)}function i(t,e){return t[1]}var a=t("ee").get("events"),c=t(23)(a,!0),s=t("gos"),f=XMLHttpRequest,u="addEventListener",d="removeEventListener";e.exports=a,"getPrototypeOf"in Object?(r(document),r(window),r(f.prototype)):f.prototype.hasOwnProperty(u)&&(o(window),o(f.prototype)),a.on(u+"-start",function(t,e){var n=t[1],r=s(n,"nr@wrapped",function(){function t(){if("function"==typeof n.handleEvent)return n.handleEvent.apply(n,arguments)}var e={object:t,"function":n}[typeof n];return e?c(e,"fn-",null,e.name||"anonymous"):n});this.wrapped=t[1]=r}),a.on(d+"-start",function(t){t[1]=this.wrapped||t[1]})},{}],7:[function(t,e,n){function r(t,e,n){var r=t[e];"function"==typeof r&&(t[e]=function(){var t=r.apply(this,arguments);return o.emit(n+"start",arguments,t),t.then(function(e){return o.emit(n+"end",[null,e],t),e},function(e){throw o.emit(n+"end",[e],t),e})})}var o=t("ee").get("fetch"),i=t(20);e.exports=o;var a=window,c="fetch-",s=c+"body-",f=["arrayBuffer","blob","json","text","formData"],u=a.Request,d=a.Response,p=a.fetch,h="prototype";u&&d&&p&&(i(f,function(t,e){r(u[h],e,s),r(d[h],e,s)}),r(a,"fetch",c),o.on(c+"end",function(t,e){var n=this;e?e.clone().arrayBuffer().then(function(t){n.rxSize=t.byteLength,o.emit(c+"done",[null,e],n)}):o.emit(c+"done",[t],n)}))},{}],8:[function(t,e,n){var r=t("ee").get("history"),o=t(23)(r);e.exports=r,o.inPlace(window.history,["pushState","replaceState"],"-")},{}],9:[function(t,e,n){function r(t){function e(){s.emit("jsonp-end",[],p),t.removeEventListener("load",e,!1),t.removeEventListener("error",n,!1)}function n(){s.emit("jsonp-error",[],p),s.emit("jsonp-end",[],p),t.removeEventListener("load",e,!1),t.removeEventListener("error",n,!1)}var r=t&&"string"==typeof t.nodeName&&"script"===t.nodeName.toLowerCase();if(r){var o="function"==typeof t.addEventListener;if(o){var a=i(t.src);if(a){var u=c(a),d="function"==typeof u.parent[u.key];if(d){var p={};f.inPlace(u.parent,[u.key],"cb-",p),t.addEventListener("load",e,!1),t.addEventListener("error",n,!1),s.emit("new-jsonp",[t.src],p)}}}}}function o(){return"addEventListener"in window}function i(t){var e=t.match(u);return e?e[1]:null}function a(t,e){var n=t.match(p),r=n[1],o=n[3];return o?a(o,e[r]):e[r]}function c(t){var e=t.match(d);return e&&e.length>=3?{key:e[2],parent:a(e[1],window)}:{key:t,parent:window}}var s=t("ee").get("jsonp"),f=t(23)(s);if(e.exports=s,o()){var u=/[?&](?:callback|cb)=([^&#]+)/,d=/(.*)\.([^.]+)/,p=/^(\w+)(\.|$)(.*)$/,h=["appendChild","insertBefore","replaceChild"];f.inPlace(HTMLElement.prototype,h,"dom-"),f.inPlace(HTMLHeadElement.prototype,h,"dom-"),f.inPlace(HTMLBodyElement.prototype,h,"dom-"),s.on("dom-start",function(t){r(t[0])})}},{}],10:[function(t,e,n){var r=t("ee").get("mutation"),o=t(23)(r),i=NREUM.o.MO;e.exports=r,i&&(window.MutationObserver=function(t){return this instanceof i?new i(o(t,"fn-")):i.apply(this,arguments)},MutationObserver.prototype=i.prototype)},{}],11:[function(t,e,n){function r(t){var e=a.context(),n=c(t,"executor-",e),r=new f(n);return a.context(r).getCtx=function(){return e},a.emit("new-promise",[r,e],e),r}function o(t,e){return e}var i=t(23),a=t("ee").get("promise"),c=i(a),s=t(20),f=NREUM.o.PR;e.exports=a,f&&(window.Promise=r,["all","race"].forEach(function(t){var e=f[t];f[t]=function(n){function r(t){return function(){a.emit("propagate",[null,!o],i),o=o||!t}}var o=!1;s(n,function(e,n){Promise.resolve(n).then(r("all"===t),r(!1))});var i=e.apply(f,arguments),c=f.resolve(i);return c}}),["resolve","reject"].forEach(function(t){var e=f[t];f[t]=function(t){var n=e.apply(f,arguments);return t!==n&&a.emit("propagate",[t,!0],n),n}}),f.prototype["catch"]=function(t){return this.then(null,t)},f.prototype=Object.create(f.prototype,{constructor:{value:r}}),s(Object.getOwnPropertyNames(f),function(t,e){try{r[e]=f[e]}catch(n){}}),a.on("executor-start",function(t){t[0]=c(t[0],"resolve-",this),t[1]=c(t[1],"resolve-",this)}),a.on("executor-err",function(t,e,n){t[1](n)}),c.inPlace(f.prototype,["then"],"then-",o),a.on("then-start",function(t,e){this.promise=e,t[0]=c(t[0],"cb-",this),t[1]=c(t[1],"cb-",this)}),a.on("then-end",function(t,e,n){this.nextPromise=n;var r=this.promise;a.emit("propagate",[r,!0],n)}),a.on("cb-end",function(t,e,n){a.emit("propagate",[n,!0],this.nextPromise)}),a.on("propagate",function(t,e,n){this.getCtx&&!e||(this.getCtx=function(){if(t instanceof Promise)var e=a.context(t);return e&&e.getCtx?e.getCtx():this})}),r.toString=function(){return""+f})},{}],12:[function(t,e,n){var r=t("ee").get("raf"),o=t(23)(r),i="equestAnimationFrame";e.exports=r,o.inPlace(window,["r"+i,"mozR"+i,"webkitR"+i,"msR"+i],"raf-"),r.on("raf-start",function(t){t[0]=o(t[0],"fn-")})},{}],13:[function(t,e,n){function r(t,e,n){t[0]=a(t[0],"fn-",null,n)}function o(t,e,n){this.method=n,this.timerDuration=isNaN(t[1])?0:+t[1],t[0]=a(t[0],"fn-",this,n)}var i=t("ee").get("timer"),a=t(23)(i),c="setTimeout",s="setInterval",f="clearTimeout",u="-start",d="-";e.exports=i,a.inPlace(window,[c,"setImmediate"],c+d),a.inPlace(window,[s],s+d),a.inPlace(window,[f,"clearImmediate"],f+d),i.on(s+u,r),i.on(c+u,o)},{}],14:[function(t,e,n){function r(t,e){d.inPlace(e,["onreadystatechange"],"fn-",c)}function o(){var t=this,e=u.context(t);t.readyState>3&&!e.resolved&&(e.resolved=!0,u.emit("xhr-resolved",[],t)),d.inPlace(t,y,"fn-",c)}function i(t){b.push(t),l&&(x?x.then(a):v?v(a):(E=-E,P.data=E))}function a(){for(var t=0;t<b.length;t++)r([],b[t]);b.length&&(b=[])}function c(t,e){return e}function s(t,e){for(var n in t)e[n]=t[n];return e}t(6);var f=t("ee"),u=f.get("xhr"),d=t(23)(u),p=NREUM.o,h=p.XHR,l=p.MO,m=p.PR,v=p.SI,w="readystatechange",y=["onload","onerror","onabort","onloadstart","onloadend","onprogress","ontimeout"],b=[];e.exports=u;var g=window.XMLHttpRequest=function(t){var e=new h(t);try{u.emit("new-xhr",[e],e),e.addEventListener(w,o,!1)}catch(n){try{u.emit("internal-error",[n])}catch(r){}}return e};if(s(h,g),g.prototype=h.prototype,d.inPlace(g.prototype,["open","send"],"-xhr-",c),u.on("send-xhr-start",function(t,e){r(t,e),i(e)}),u.on("open-xhr-start",r),l){var x=m&&m.resolve();if(!v&&!m){var E=1,P=document.createTextNode(E);new l(a).observe(P,{characterData:!0})}}else f.on("fn-end",function(t){t[0]&&t[0].type===w||a()})},{}],15:[function(t,e,n){function r(t){var e=this.params,n=this.metrics;if(!this.ended){this.ended=!0;for(var r=0;r<d;r++)t.removeEventListener(u[r],this.listener,!1);if(!e.aborted){if(n.duration=a.now()-this.startTime,4===t.readyState){e.status=t.status;var i=o(t,this.lastSize);if(i&&(n.rxSize=i),this.sameOrigin){var s=t.getResponseHeader("X-NewRelic-App-Data");s&&(e.cat=s.split(", ").pop())}}else e.status=0;n.cbTime=this.cbTime,f.emit("xhr-done",[t],t),c("xhr",[e,n,this.startTime])}}}function o(t,e){var n=t.responseType;if("json"===n&&null!==e)return e;var r="arraybuffer"===n||"blob"===n||"json"===n?t.response:t.responseText;return l(r)}function i(t,e){var n=s(e),r=t.params;r.host=n.hostname+":"+n.port,r.pathname=n.pathname,t.sameOrigin=n.sameOrigin}var a=t("loader");if(a.xhrWrappable){var c=t("handle"),s=t(16),f=t("ee"),u=["load","error","abort","timeout"],d=u.length,p=t("id"),h=t(19),l=t(18),m=window.XMLHttpRequest;a.features.xhr=!0,t(14),f.on("new-xhr",function(t){var e=this;e.totalCbs=0,e.called=0,e.cbTime=0,e.end=r,e.ended=!1,e.xhrGuids={},e.lastSize=null,h&&(h>34||h<10)||window.opera||t.addEventListener("progress",function(t){e.lastSize=t.loaded},!1)}),f.on("open-xhr-start",function(t){this.params={method:t[0]},i(this,t[1]),this.metrics={}}),f.on("open-xhr-end",function(t,e){"loader_config"in NREUM&&"xpid"in NREUM.loader_config&&this.sameOrigin&&e.setRequestHeader("X-NewRelic-ID",NREUM.loader_config.xpid)}),f.on("send-xhr-start",function(t,e){var n=this.metrics,r=t[0],o=this;if(n&&r){var i=l(r);i&&(n.txSize=i)}this.startTime=a.now(),this.listener=function(t){try{"abort"===t.type&&(o.params.aborted=!0),("load"!==t.type||o.called===o.totalCbs&&(o.onloadCalled||"function"!=typeof e.onload))&&o.end(e)}catch(n){try{f.emit("internal-error",[n])}catch(r){}}};for(var c=0;c<d;c++)e.addEventListener(u[c],this.listener,!1)}),f.on("xhr-cb-time",function(t,e,n){this.cbTime+=t,e?this.onloadCalled=!0:this.called+=1,this.called!==this.totalCbs||!this.onloadCalled&&"function"==typeof n.onload||this.end(n)}),f.on("xhr-load-added",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&!this.xhrGuids[n]&&(this.xhrGuids[n]=!0,this.totalCbs+=1)}),f.on("xhr-load-removed",function(t,e){var n=""+p(t)+!!e;this.xhrGuids&&this.xhrGuids[n]&&(delete this.xhrGuids[n],this.totalCbs-=1)}),f.on("addEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-added",[t[1],t[2]],e)}),f.on("removeEventListener-end",function(t,e){e instanceof m&&"load"===t[0]&&f.emit("xhr-load-removed",[t[1],t[2]],e)}),f.on("fn-start",function(t,e,n){e instanceof m&&("onload"===n&&(this.onload=!0),("load"===(t[0]&&t[0].type)||this.onload)&&(this.xhrCbStart=a.now()))}),f.on("fn-end",function(t,e){this.xhrCbStart&&f.emit("xhr-cb-time",[a.now()-this.xhrCbStart,this.onload,e],e)})}},{}],16:[function(t,e,n){e.exports=function(t){var e=document.createElement("a"),n=window.location,r={};e.href=t,r.port=e.port;var o=e.href.split("://");!r.port&&o[1]&&(r.port=o[1].split("/")[0].split("@").pop().split(":")[1]),r.port&&"0"!==r.port||(r.port="https"===o[0]?"443":"80"),r.hostname=e.hostname||n.hostname,r.pathname=e.pathname,r.protocol=o[0],"/"!==r.pathname.charAt(0)&&(r.pathname="/"+r.pathname);var i=!e.protocol||":"===e.protocol||e.protocol===n.protocol,a=e.hostname===document.domain&&e.port===n.port;return r.sameOrigin=i&&(!e.hostname||a),r}},{}],17:[function(t,e,n){function r(){}function o(t,e,n){return function(){return i(t,[f.now()].concat(c(arguments)),e?null:this,n),e?void 0:this}}var i=t("handle"),a=t(20),c=t(21),s=t("ee").get("tracer"),f=t("loader"),u=NREUM;"undefined"==typeof window.newrelic&&(newrelic=u);var d=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],p="api-",h=p+"ixn-";a(d,function(t,e){u[e]=o(p+e,!0,"api")}),u.addPageAction=o(p+"addPageAction",!0),u.setCurrentRouteName=o(p+"routeName",!0),e.exports=newrelic,u.interaction=function(){return(new r).get()};var l=r.prototype={createTracer:function(t,e){var n={},r=this,o="function"==typeof e;return i(h+"tracer",[f.now(),t,n],r),function(){if(s.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return e.apply(this,arguments)}catch(t){throw s.emit("fn-err",[arguments,this,t],n),t}finally{s.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(t,e){l[e]=o(h+e)}),newrelic.noticeError=function(t){"string"==typeof t&&(t=new Error(t)),i("err",[t,f.now()])}},{}],18:[function(t,e,n){e.exports=function(t){if("string"==typeof t&&t.length)return t.length;if("object"==typeof t){if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer&&t.byteLength)return t.byteLength;if("undefined"!=typeof Blob&&t instanceof Blob&&t.size)return t.size;if(!("undefined"!=typeof FormData&&t instanceof FormData))try{return JSON.stringify(t).length}catch(e){return}}}},{}],19:[function(t,e,n){var r=0,o=navigator.userAgent.match(/Firefox[\/\s](\d+\.\d+)/);o&&(r=+o[1]),e.exports=r},{}],20:[function(t,e,n){function r(t,e){var n=[],r="",i=0;for(r in t)o.call(t,r)&&(n[i]=e(r,t[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],21:[function(t,e,n){function r(t,e,n){e||(e=0),"undefined"==typeof n&&(n=t?t.length:0);for(var r=-1,o=n-e||0,i=Array(o<0?0:o);++r<o;)i[r]=t[e+r];return i}e.exports=r},{}],22:[function(t,e,n){e.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],23:[function(t,e,n){function r(t){return!(t&&t instanceof Function&&t.apply&&!t[a])}var o=t("ee"),i=t(21),a="nr@original",c=Object.prototype.hasOwnProperty,s=!1;e.exports=function(t,e){function n(t,e,n,o){function nrWrapper(){var r,a,c,s;try{a=this,r=i(arguments),c="function"==typeof n?n(r,a):n||{}}catch(f){p([f,"",[r,a,o],c])}u(e+"start",[r,a,o],c);try{return s=t.apply(a,r)}catch(d){throw u(e+"err",[r,a,d],c),d}finally{u(e+"end",[r,a,s],c)}}return r(t)?t:(e||(e=""),nrWrapper[a]=t,d(t,nrWrapper),nrWrapper)}function f(t,e,o,i){o||(o="");var a,c,s,f="-"===o.charAt(0);for(s=0;s<e.length;s++)c=e[s],a=t[c],r(a)||(t[c]=n(a,f?c+o:o,i,c))}function u(n,r,o){if(!s||e){var i=s;s=!0;try{t.emit(n,r,o,e)}catch(a){p([a,n,r,o])}s=i}}function d(t,e){if(Object.defineProperty&&Object.keys)try{var n=Object.keys(t);return n.forEach(function(n){Object.defineProperty(e,n,{get:function(){return t[n]},set:function(e){return t[n]=e,e}})}),e}catch(r){p([r])}for(var o in t)c.call(t,o)&&(e[o]=t[o]);return e}function p(e){try{t.emit("internal-error",e)}catch(n){}}return t||(t=o),n.inPlace=f,n.flag=a,n}},{}],ee:[function(t,e,n){function r(){}function o(t){function e(t){return t&&t instanceof r?t:t?s(t,c,i):i()}function n(n,r,o,i){if(!p.aborted||i){t&&t(n,r,o);for(var a=e(o),c=l(n),s=c.length,f=0;f<s;f++)c[f].apply(a,r);var d=u[y[n]];return d&&d.push([b,n,r,a]),a}}function h(t,e){w[t]=l(t).concat(e)}function l(t){return w[t]||[]}function m(t){return d[t]=d[t]||o(n)}function v(t,e){f(t,function(t,n){e=e||"feature",y[n]=e,e in u||(u[e]=[])})}var w={},y={},b={on:h,emit:n,get:m,listeners:l,context:e,buffer:v,abort:a,aborted:!1};return b}function i(){return new r}function a(){(u.api||u.feature)&&(p.aborted=!0,u=p.backlog={})}var c="nr@context",s=t("gos"),f=t(20),u={},d={},p=e.exports=o();p.backlog=u},{}],gos:[function(t,e,n){function r(t,e,n){if(o.call(t,e))return t[e];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(t,e,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return t[e]=r,r}var o=Object.prototype.hasOwnProperty;e.exports=r},{}],handle:[function(t,e,n){function r(t,e,n,r){o.buffer([t],r),o.emit(t,e,n)}var o=t("ee").get("handle");e.exports=r,r.ee=o},{}],id:[function(t,e,n){function r(t){var e=typeof t;return!t||"object"!==e&&"function"!==e?-1:t===window?0:a(t,i,function(){return o++})}var o=1,i="nr@id",a=t("gos");e.exports=r},{}],loader:[function(t,e,n){function r(){if(!x++){var t=g.info=NREUM.info,e=p.getElementsByTagName("script")[0];if(setTimeout(u.abort,3e4),!(t&&t.licenseKey&&t.applicationID&&e))return u.abort();f(y,function(e,n){t[e]||(t[e]=n)}),s("mark",["onload",a()+g.offset],null,"api");var n=p.createElement("script");n.src="https://"+t.agent,e.parentNode.insertBefore(n,e)}}function o(){"complete"===p.readyState&&i()}function i(){s("mark",["domContent",a()+g.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(c=Math.max((new Date).getTime(),c))-g.offset}var c=(new Date).getTime(),s=t("handle"),f=t(20),u=t("ee"),d=window,p=d.document,h="addEventListener",l="attachEvent",m=d.XMLHttpRequest,v=m&&m.prototype;NREUM.o={ST:setTimeout,SI:d.setImmediate,CT:clearTimeout,XHR:m,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var w=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-spa-1071.min.js"},b=m&&v&&v[h]&&!/CriOS/.test(navigator.userAgent),g=e.exports={offset:c,now:a,origin:w,features:{},xhrWrappable:b};t(17),p[h]?(p[h]("DOMContentLoaded",i,!1),d[h]("load",r,!1)):(p[l]("onreadystatechange",o),d[l]("onload",r)),s("mark",["firstbyte",c],null,"api");var x=0,E=t(22)},{}]},{},["loader",2,15,5,3,4]);
;NREUM.info={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",licenseKey:"13e44ec848",applicationID:"187820761",sa:1}
</script>


  <!-- FullStory -->
  <!-- <script>
/* eslint-disable */
window['_fs_debug'] = false;
window['_fs_host'] = 'fullstory.com';
window['_fs_org'] = '7JS2S';
window['_fs_namespace'] = 'FS';
(function(m,n,e,t,l,o,g,y){
    if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
    g=m[e]=function(a,b){g.q?g.q.push([a,b]):g._api(a,b);};g.q=[];
    o=n.createElement(t);o.async=1;o.src='https://'+_fs_host+'/s/fs.js';
    y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
    g.identify=function(i,v){g(l,{uid:i});if(v)g(l,v)};g.setUserVars=function(v){g(l,v)};g.event=function(i,v){g('event',{n:i,p:v})};
    g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
    g.consent=function(a){g("consent",!arguments.length||a)};
    g.identifyAccount=function(i,v){o='account';v=v||{};v.acctId=i;g(o,v)};
    g.clearUserCookie=function(){};
})(window,document,window['_fs_namespace'],'script','user');
</script>
 -->

  <!-- Delighted -->
  <script type="text/javascript">
/* eslint-disable */
  !function(e,t,r,n,a){if(!e[a]){for(var i=e[a]=[],s=0;s<r.length;s++){var c=r[s];i[c]=i[c]||function(e){return function(){var t=Array.prototype.slice.call(arguments);i.push([e,t])}}(c)}i.SNIPPET_VERSION="1.0.1";var o=t.createElement("script");o.type="text/javascript",o.async=!0,o.src="https://d2yyd1h5u9mauk.cloudfront.net/integrations/web/v1/library/"+n+"/"+a+".js";var u=t.getElementsByTagName("script")[0];u.parentNode.insertBefore(o,u)}}(window,document,["survey","reset","config","init","set","get","event","identify","track","page","screen","group","alias"],"Mvwmq6n6DhInaFYu","delighted");

  delighted.survey();
</script>


  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "name": "KongHQ",
      "url": "https://docs.konghq.com",
      "logo": "https://docs.konghq.com/assets/images/logo.png",
      "sameAs": [
        "https://www.facebook.com/konginc",
        "https://twitter.com/thekonginc",
        "https://plus.google.com/+mashape"
      ]
    }
  </script>

  <!-- Preload assets -->
  <link rel="dns-prefetch" href="//cloud.typography.com" />
  <link
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700"
    rel="stylesheet"
  />
  <link rel="dns-prefetch" href="//dev.visualwebsiteoptimizer.com" />
  <link rel="dns-prefetch" href="//cdn.segment.com" />

  <!-- Recaptcha -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- ##gulp-resource-hints## -->

  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"
  />
  <link
    rel="stylesheet"
    href="/assets/styles.css?v=1573061372"
  />
  
</head>

<!-- Kong Cookie Policy -->
<div class="cookie-policy-container">
  <p>In order to give you better service we use cookies. By continuing to use our website, you agree to the use of cookies as described in our <a href=" https://konghq.com/cookie-policy/">Cookie Policy</a>
  <button class="cookie-policy-accept btn button" type="submit">I Agree</button>
</div>



  <body
    id=""
    
    data-spy="scroll"
    data-target="#scroll-sidebar"
    data-offset="350"
  >
    <header class="navbar navbar-inverse navbar-toggleable-lg kong-navbar flex-row align-items-center fixed-top lower_nav expand">
    <div class="container d-flex">
      <a href="https://konghq.com/" class="navbar-brand col col-xl-auto">
      <img src="https://2tjosk2rxzc21medji3nfn1g-wpengine.netdna-ssl.com/wp-content/themes/konghq/assets/img/gradient-logo.svg" alt="Kong Logo">
      </a>
      <button class="navbar-toggler align-self-center" type="button" data-toggle="kong-expand" data-target="#pagesNav" aria-controls="pagesNav" aria-expanded="false" aria-label="Toggle navigation">
        <div></div>
        <div></div>
        <div></div>
      </button>
      <nav class="navbar full-width">
        <div class="collapse navbar-collapse col justify-content-md-end kong-navbar_nav">
          <ul id="menu-primary-nav" class="menu">
            <li class="btn menu-item menu-item-type-custom menu-item-object-custom menu-item-12447 navbar-item"><a href="https://konghq.com/request-demo" class="nav-link">Request Demo</a></li>
            <li class="btn menu-item menu-item-type-custom menu-item-object-custom menu-item-12448 navbar-item"><a href="https://konghq.com/install" class="nav-link">Install</a></li>
            <li class="two-row nav1 menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor menu-item-has-children menu-item-12449 navbar-item">
              <a href="#" class="nav-link">Products</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom current-menu-ancestor current-menu-parent menu-item-has-children menu-item-12450 navbar-item">
                  <a href="https://konghq.com/kong" class="nav-link">Kong Gateway</a>
                  <div class="nav-btns"><a class="navbtn" href="https://konghq.com/install">Install Kong Open Source</a></div>
                  <ul class="sub-menu">
                    <li class="mobile-nav menu-item menu-item-type-custom menu-item-object-custom menu-item-12451 navbar-item"><a href="https://konghq.com/kong" class="nav-link">Overview</a></li>
                    <li class="stacked menu-item menu-item-type-custom menu-item-object-custom current-menu-item menu-item-12452 navbar-item">
                      <a href="https://konghq.com/products/kong-gateway/control-api" aria-current="page" class="nav-link">
                        <img src="/assets/images/nav/control.svg"> Control API
                        <p class="description">Own your Kong experience to customize your API and microservices workflows.</p>
                      </a>
                    </li>
                    <li id="menu-item-12453" class="nav3 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12453 navbar-item">
                      <a href="https://konghq.com/products/kong-gateway/kong-proxy" class="nav-link">
                        <img src="/assets/images/nav/proxy.svg"> Kong Proxy
                        <p class="description">Deliver performance needed for microservices, service mesh, and cloud native deployments.</p>
                      </a>
                      <ul class="sub-menu">
                        <li class="mobile-nav menu-item menu-item-type-custom menu-item-object-custom menu-item-12466 navbar-item"><a href="https://konghq.com/products/kong-gateway/kong-proxy" class="nav-link">Overview</a></li>
                        <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12467 navbar-item"><a href="https://konghq.com/products/kong-enterprise/multi-protocol" class="nav-link">Multi-protocol</a></li>
                      </ul>
                    </li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12454 navbar-item">
                      <a href="https://konghq.com/products/kong-gateway/kong-plugins" class="nav-link">
                        <img src="/assets/images/nav/plugins.svg"> Kong Plugins
                        <p class="description">Unleash the full power of Kong with a robust ecosystem of plugins.</p>
                      </a>
                    </li>
                  </ul>
                </li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12455 navbar-item">
                  <a href="https://konghq.com/products/kong-enterprise" class="nav-link">Kong Enterprise</a>
                  <div class="nav-btns"><a class="navbtn" href="https://konghq.com/request-demo">Demo</a><a class="navbtn" href="https://konghq.com/kong-cloud">Free Trial</a></div>
                  <ul class="sub-menu">
                    <li class="mobile-nav menu-item menu-item-type-custom menu-item-object-custom menu-item-12456 navbar-item"><a href="https://konghq.com/products/kong-enterprise" class="nav-link">Overview</a></li>
                    <li class="nav3 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12457 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/kong-manager" class="nav-link">
                        <img src="/assets/images/nav/manager.svg"> Kong Manager
                        <p class="description">Monitor and manage all your services with a consumer-grade interface.</p>
                      </a>
                      <ul class="sub-menu">
                        <li class="mobile-nav menu-item menu-item-type-custom menu-item-object-custom menu-item-12458 navbar-item"><a href="https://konghq.com/products/kong-enterprise/kong-manager" class="nav-link">Overview</a></li>
                        <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12459 navbar-item"><a href="https://konghq.com/products/kong-enterprise/enterprise-plugins/" class="nav-link">Enterprise Plugins</a></li>
                        <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12460 navbar-item"><a href="https://konghq.com/products/kong-enterprise/vitals/" class="nav-link">Vitals</a></li>
                      </ul>
                    </li>
                    <li class="nav3 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12461 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/teams" class="nav-link">
                        <img src="/assets/images/nav/teams.svg"> Teams
                        <p class="description">Organize developers and assign permissions to improve efficiency and compliance.</p>
                      </a>
                      <ul class="sub-menu">
                        <li class="mobile-nav menu-item menu-item-type-custom menu-item-object-custom menu-item-12462 navbar-item"><a href="https://konghq.com/products/kong-enterprise/teams" class="nav-link">Overview</a></li>
                        <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12463 navbar-item"><a href="https://konghq.com/products/kong-enterprise/role-based-access-control/" class="nav-link">RBAC</a></li>
                        <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12464 navbar-item"><a href="https://konghq.com/products/kong-enterprise/workspaces/" class="nav-link">Workspaces</a></li>
                      </ul>
                    </li>
                    <li class="nav3 menu-item menu-item-type-custom menu-item-object-custom menu-item-12465 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/kong-studio" class="nav-link">
                        <img src="/assets/images/nav/studio.svg"> Kong Studio
                        <p class="description">Empower your developers with the Kong Studio Integrated Development Environment.</p>
                      </a>
                    </li>
                    <li class="border-top menu-item menu-item-type-custom menu-item-object-custom menu-item-12468 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/dev-portal" class="nav-link">
                        <img src="/assets/images/nav/dev-portal.svg"> Dev Portal
                        <p class="description">Accelerate innovation across your organization with the Kong Developer Portal.</p>
                      </a>
                    </li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12469 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/kong-brain" class="nav-link">
                        <img src="/assets/images/nav/brain-updated.svg"> Brain
                        <p class="description">Automatically standardize documentation and create a visual map of your services.</p>
                      </a>
                    </li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12470 navbar-item">
                      <a href="https://konghq.com/products/kong-enterprise/kong-immunity" class="nav-link">
                        <img src="/assets/images/nav/immunity.svg"> Immunity
                        <p class="description">Autonomously identify service issues with machine learning-powered anomaly detection.</p>
                      </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li class="one-col nav1 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12471 navbar-item">
              <a href="#" class="nav-link">Solutions</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12472 navbar-item">
                  <a href="https://konghq.com/kong" class="nav-link">
                    <img src="/assets/images/nav/api-gateway.svg"> API Gateway
                    <p class="description">Take control of your microservices traffic with the world’s most popular API gateway.</p>
                  </a>
                </li>
                <li id="menu-item-12473" class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12473 navbar-item">
                  <a href="https://konghq.com/solutions/kubernetes-ingress" class="nav-link">
                    <img src="/assets/images/nav/kubernetes.svg"> Kubernetes
                    <p class="description">Own your Kubernetes cluster by extending Kong functionality as an ingress controller.</p>
                  </a>
                </li>
                <li id="menu-item-12474" class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12474 navbar-item">
                  <a href="https://konghq.com/solutions/service-mesh/" class="nav-link">
                    <img src="/assets/images/nav/service-mesh.svg"> Service Mesh
                    <p class="description">Inject Kong as a sidecar for your services to go from mess to mesh.</p>
                  </a>
                </li>
              </ul>
            </li>
            <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12471 navbar-item">
                <a href="/hub" class="nav-link">Plugins</a>
            </li>
            <li class="one-col nav1 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12475 navbar-item">
              <a href="#" class="nav-link">Open Source</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12476 navbar-item"><a href="https://konghq.com/install" class="nav-link"><img src="/assets/images/nav/install.svg"> Install Kong Gateway</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12477 navbar-item"><a href="https://konghq.com/community/" class="nav-link"><img src="/assets/images/nav/community.svg"> Kong Community</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12478 navbar-item"><a target="_blank" href="https://github.com/Kong/kubernetes-ingress-controller" class="nav-link"><img src="/assets/images/nav/kubernetes.svg"> Kubernetes Ingress</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12479 navbar-item"><a target="_blank" href="https://kuma.io" class="nav-link"><img src="/assets/images/nav/kuma.svg"> Kuma</a></li>
                <li class="nav2 hidden menu-item menu-item-type-custom menu-item-object-custom menu-item-12480 navbar-item"><a target="_blank" href="https://insomnia.rest/" class="nav-link"><img src="/assets/images/nav/insomnia.svg"> Insomnia</a></li>
              </ul>
            </li>
            <li class="multicol wide nav1 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12481 navbar-item">
              <a target="_blank" href="https://docs.konghq.com" class="nav-link">Docs</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12482 navbar-item">
                  <a class="nav-link">Get Started</a>
                  <ul class="sub-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12484 navbar-item"><a href="https://konghq.com/install" class="nav-link"><img src="/assets/images/nav/install-thick.svg"> Install</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12485 navbar-item"><a target="_blank" href="https://docs.konghq.com/?_ga=2.154852088.1919773651.1569859116-132287075.1554308608" class="nav-link"><img src="/assets/images/nav/getting-started-thick.svg"> Kong Docs + Getting Started</a></li>
                  </ul>
                </li>
                <li id="menu-item-12483" class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12483 navbar-item">
                  <a class="nav-link">Learn</a>
                  <ul class="sub-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12486 navbar-item"><a target="_blank" href="https://docs.konghq.com/enterprise/?_ga=2.154852088.1919773651.1569859116-132287075.1554308608" class="nav-link"><img src="/assets/images/nav/deploy-plugins-master-launch.svg"> Deploy Kong Enterprise</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12487 navbar-item"><a target="_blank" href="https://docs.konghq.com/hub/" class="nav-link"><img src="/assets/images/nav/deploy-plugins-master-launch.svg"> Plugins</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12488 navbar-item"><a target="_blank" href="https://docs.konghq.com/enterprise/latest/admin-api/vitals/" class="nav-link"><img src="/assets/images/nav/deploy-plugins-master-launch.svg"> Master Kong Vitals</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12489 navbar-item"><a target="_blank" href="https://docs.konghq.com/enterprise/0.36-x/developer-portal/introduction/" class="nav-link"><img src="/assets/images/nav/deploy-plugins-master-launch.svg"> Launch Your Dev Portal</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li class="multicol nav1 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12490 navbar-item">
              <a href="#" class="nav-link">Resources</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12491 navbar-item">
                  <a class="nav-link">Downloads</a>
                  <ul class="sub-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12495 navbar-item"><a href="https://konghq.com/ebooks/" class="nav-link"><img src="/assets/images/nav/ebooks.svg"> eBooks</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12496 navbar-item"><a href="https://konghq.com/webinars/" class="nav-link"><img src="/assets/images/nav/webinars.svg"> Webinars</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12497 navbar-item"><a href="https://konghq.com/briefs" class="nav-link"><img src="/assets/images/nav/briefs.svg"> Briefs</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12494 navbar-item"><a href="https://konghq.com/blog/" class="nav-link"><img src="/assets/images/nav/blog.svg"> Blog</a></li>
                  </ul>
                </li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12492 navbar-item">
                  <a class="nav-link">Community</a>
                  <ul class="sub-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12500 navbar-item"><a href="https://konghq.com/community/" class="nav-link"><img src="/assets/images/nav/meetups.svg"> Community</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12498 navbar-item"><a target="_blank" href="https://discuss.konghq.com/?_ga=2.147363831.1919773651.1569859116-132287075.1554308608" class="nav-link"><img src="/assets/images/nav/kong-nation.svg"> Kong Nation</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12501 navbar-item"><a href="https://konghq.com/kong-summit" class="nav-link"><img src="/assets/images/nav/summit.svg"> Kong Summit</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12499 navbar-item"><a target="_blank" href="https://github.com/Kong/" class="nav-link"><img src="/assets/images/nav/github.svg"> GitHub</a></li>
                  </ul>
                </li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12493 navbar-item">
                  <a class="nav-link">Support</a>
                  <ul class="sub-menu">
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12502 navbar-item"><a target="_blank" href="https://support.konghq.com/s/" class="nav-link"><img src="/assets/images/nav/support-faqs.svg"> Enterprise Support Portal</a></li>
                    <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-12503 navbar-item"><a href="https://konghq.com/faqs" class="nav-link"><img src="/assets/images/nav/support-faqs.svg"> FAQS</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li id="menu-item-12504" class="one-col icn-sm nav1 menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-12504 navbar-item">
              <a href="#" class="nav-link">Company</a>
              <ul class="sub-menu">
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12505 navbar-item"><a href="https://konghq.com/about-kong-inc" class="nav-link"><img src="/assets/images/nav/about.svg"> About</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12505 navbar-item"><a href="https://konghq.com/customers/" class="nav-link"><img src="/assets/images/nav/meetups.svg"> Customers</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12506 navbar-item"><a href="https://konghq.com/investors" class="nav-link"><img src="/assets/images/nav/investors.svg"> Investors</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12507 navbar-item"><a href="https://konghq.com/careers/" class="nav-link"><img src="/assets/images/nav/careers.svg"> Careers</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12508 navbar-item"><a href="https://konghq.com/partners" class="nav-link"><img src="/assets/images/nav/partners.svg"> Partners</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12509 navbar-item"><a href="https://konghq.com/press-room" class="nav-link"><img src="/assets/images/nav/press.svg"> Press</a></li>
                <li class="nav2 menu-item menu-item-type-custom menu-item-object-custom menu-item-12510 navbar-item"><a href="https://konghq.com/contact" class="nav-link"><img src="/assets/images/nav/contact.svg"> Contact</a></li>
              </ul>
            </li>
            <li class="demo-btn menu-item menu-item-type-custom menu-item-object-custom menu-item-12511 navbar-item"><a href="https://konghq.com/request-demo" class="nav-link">Request Demo</a></li>
          </ul>
        </div>
      </nav>
    </div>
  </header>


    <div class="page ">
  <header class="page-header">
    <div class="container">
      <div class="edit-this-page">
        <a target="_blank" href="https://github.com/Kong/docs.konghq.com/tree/master/app/1.0.x/plugin-development/custom-entities.md"><i class="fa fa-github"></i>
          Edit this Page</a>
      </div>
      <nav class="docs-navigation">
        <a href="/"  class="active" >Kong</a>
        <a href="/enterprise" >Kong Enterprise</a>
        <span class="sidebar-toggle">Open Sidebar</span>
      </nav>
      <div class="page-header-icon">
        <img src="/assets/images/icons/icn-documentation-ce.svg"
          alt="Documentation" />
      </div>
      <div class="page-header-title">
        <h1>Plugin Development - Storing Custom Entities</h1>
      </div>

      
      <div class="versions-dropdown dropdown page-header-right ">
        <button class="page-header-btn" id="version-dropdown" type="button" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
          Version 1.0.x
          
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="version-dropdown">
          
          <li >
            <a href="/1.4.x" >
              1.4.x <em>(latest)</em>
            </a>
          </li>
          
          <li >
            <a href="/1.3.x" >
              1.3.x 
            </a>
          </li>
          
          <li >
            <a href="/1.2.x" >
              1.2.x 
            </a>
          </li>
          
          <li >
            <a href="/1.1.x" >
              1.1.x 
            </a>
          </li>
          
          <li  class="active" >
            <a href="/1.0.x"  class="active" >
              1.0.x 
            </a>
          </li>
          
          <li >
            <a href="/0.14.x" >
              0.14.x 
            </a>
          </li>
          
          <li >
            <a href="/0.13.x" >
              0.13.x 
            </a>
          </li>
          
          <li >
            <a href="/0.12.x" >
              0.12.x 
            </a>
          </li>
          
          <li >
            <a href="/0.11.x" >
              0.11.x 
            </a>
          </li>
          
          <li >
            <a href="/0.10.x" >
              0.10.x 
            </a>
          </li>
          
          <li >
            <a href="/0.9.x" >
              0.9.x 
            </a>
          </li>
          
          <li >
            <a href="/0.8.x" >
              0.8.x 
            </a>
          </li>
          
          <li >
            <a href="/0.7.x" >
              0.7.x 
            </a>
          </li>
          
          <li >
            <a href="/0.6.x" >
              0.6.x 
            </a>
          </li>
          
          <li >
            <a href="/0.5.x" >
              0.5.x 
            </a>
          </li>
          
          <li >
            <a href="/0.4.x" >
              0.4.x 
            </a>
          </li>
          
          <li >
            <a href="/0.3.x" >
              0.3.x 
            </a>
          </li>
          
          <li >
            <a href="/0.2.x" >
              0.2.x 
            </a>
          </li>
          
        </ul>
        <div id="getkong-algolia-search" class="search-input">
          <i class="fa fa-search"></i>
          <input type="text" placeholder="Search" id="getkong-algolia-search-input" />
        </div>
      </div>
      
    </div>
  </header>

  <div class="container">
    <aside class="page-navigation">
      <span class="close-sidebar"></span>
      

      
      <nav>
        
        <h5>Getting Started</h5>
        
        <ul>
          
          
          <li>
            <a href="/1.0.x/getting-started/introduction"  >
              Introduction
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/getting-started/quickstart"  >
              Five-minute quickstart
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/getting-started/configuring-a-service"  >
              Configuring a Service
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/getting-started/enabling-plugins"  >
              Enabling Plugins
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/getting-started/adding-consumers"  >
              Adding Consumers
            </a>
            
          </li>
          
        </ul>
      </nav>
      
      <nav>
        
        <h5>Guides &amp; References</h5>
        
        <ul>
          
          
          <li>
            <a href="/1.0.x/configuration"  >
              Configuration reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/cli"  >
              CLI reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/proxy"  >
              Proxy reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/auth"  >
              Authentication reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/loadbalancing"  >
              Load balancing reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/health-checks-circuit-breakers"  >
              Health checks and circuit breakers reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/clustering"  >
              Clustering reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/logging"  >
              Logging reference
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/network"  >
              Network &amp; Firewall
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/secure-admin-api"  >
              Securing the Admin API
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/plugin-development"  >
              Plugin Development Guide
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/plugin-development" >Introduction</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/file-structure" >File structure</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/custom-logic" >Implementing custom logic</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/plugin-configuration" >Plugin configuration</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/access-the-datastore" >Accessing the datastore</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/custom-entities" class="active" >Storing custom entities</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/entities-cache" >Caching custom entities</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/admin-api" >Extending the Admin API</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/tests" >Writing tests</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/plugin-development/distribution" >(un)Installing your plugin</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/pdk"  >
              Plugin Development Kit
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.client" >kong.client</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.ctx" >kong.ctx</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.ip" >kong.ip</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.log" >kong.log</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.node" >kong.node</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.request" >kong.request</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.response" >kong.response</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.router" >kong.router</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.service" >kong.service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.service.request" >kong.service.request</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.service.response" >kong.service.response</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/pdk/kong.table" >kong.table</a>
                
              </li>
              
            </ul>
            
          </li>
          
        </ul>
      </nav>
      
      <nav>
        
        <a href="/1.0.x/admin-api/">
          <h5>Admin API</h5>
        </a>
        
        <ul>
          
          
          <li>
            <a href="/1.0.x/admin-api/#supported-content-types"  >
              Supported Content Types
            </a>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#information-routes"  >
              Information routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-node-information" >Retrieve node information</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-node-status" >Retrieve node status</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#service-object"  >
              Service Object
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-service" >Add Service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-service" >Retrieve Service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-services" >List Services</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-service" >Update Service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-service" >Update or create Service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-service" >Delete Service</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#route-object"  >
              Route Object
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-route" >Add Route</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-route" >Retrieve Route</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-routes" >List Routes</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-routes-associated-to-a-service" >List Routes associated to a Service</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-route" >Update Route</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-route" >Update or create Route</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-route" >Delete Route</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#consumer-object"  >
              Consumer Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#create-consumer" >Create Consumer</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-consumer" >Retrieve Consumer</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-consumers" >List Consumers</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-consumer" >Update Consumer</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-consumer" >Update or create Consumer</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-consumer" >Delete Consumer</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#plugin-object"  >
              Plugin Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-plugin" >Add Plugin</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-plugin" >Retrieve Plugin</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-all-plugins" >List all Plugins</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-plugin" >Update Plugin</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-add-plugin" >Update or Add Plugin</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-plugin" >Delete Plugin</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-enabled-plugins" >Retrieve Enabled Plugins</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-plugin-schema" >Retrieve Plugin Schema</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#certificate-object"  >
              Certificate Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-certificate" >Add Certificate</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-certificate" >Retrieve Certificate</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-certificates" >List Certificates</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-certificate" >Update Certificate</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-certificate" >Update or Create Certificate</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-certificate" >Delete Certificate</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#sni-objects"  >
              SNI Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-sni" >Add SNI</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-sni" >Retrieve SNI</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-snis" >List SNIs</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-sni" >Update SNI</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-sni" >Update or Create SNI</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-sni" >Delete SNI</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#upstream-objects"  >
              Upstream Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-upstream" >Add Upstream</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#retrieve-upstream" >Retrieve Upstream</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-upstreams" >List all Upstreams</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-upstream" >Update Upstream</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#update-or-create-upstream" >Update or create Upstream</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-upstream" >Delete Upstream</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#show-upstream-health-for-node" >Show Upstream health for node</a>
                
              </li>
              
            </ul>
            
          </li>
          
          
          <li>
            <a href="/1.0.x/admin-api/#target-object"  >
              Target Object routes
            </a>
            
            <ul>
              
              
              <li>
                <a href="/1.0.x/admin-api/#add-target" >Add Target</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-targets" >List Targets</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#list-all-targets" >List All Targets</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#delete-target" >Delete Target</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#set-target-as-healthy" >Set Target as Healthy</a>
                
              </li>
              
              
              <li>
                <a href="/1.0.x/admin-api/#set-target-as-unhealthy" >Set Target as Unhealthy</a>
                
              </li>
              
            </ul>
            
          </li>
          
        </ul>
      </nav>
      
    </aside>

    <div class="page-content-container" id="documentation">
      <div class="page-content">
        <div class="content show-anchor-links">
          
          <div class="alert alert-ee">
            Maybe you were looking for the <a href="/enterprise"><strong>Enterprise Documentation</strong></a>
            instead?
          </div>
          
          
          <div class="alert alert-warning">
            <strong>Careful!</strong> You are browsing documentation for an outdated version of Kong. Go <a href="/latest">here</a>
            to browse the documentation for the latest version.
          </div>
          

          
          
          <h2 id="table-of-contents">Table of Contents</h2>
          <ul>
  <li><a href="#introduction" class="scroll-to">Introduction</a></li>
  <li><a href="#modules" class="scroll-to">Modules</a></li>
  <li><a href="#create-the-migrations-folder" class="scroll-to">Create the migrations folder</a></li>
  <li><a href="#adding-a-new-migration-to-an-existing-plugin" class="scroll-to">Adding a new migration to an existing plugin</a></li>
  <li><a href="#migration-file-syntax" class="scroll-to">Migration File syntax</a></li>
  <li><a href="#defining-a-schema" class="scroll-to">Defining a Schema</a></li>
  <li><a href="#the-custom-dao" class="scroll-to">The custom DAO</a>
    <ul>
      <li><a href="#selecting-an-entity" class="scroll-to">Selecting an entity</a></li>
      <li><a href="#iterating-over-all-the-entities" class="scroll-to">Iterating over all the entities</a></li>
      <li><a href="#inserting-an-entity" class="scroll-to">Inserting an entity</a></li>
      <li><a href="#updating-an-entity" class="scroll-to">Updating an entity</a></li>
      <li><a href="#upserting-an-entity" class="scroll-to">Upserting an entity</a></li>
      <li><a href="#deleting-an-entity" class="scroll-to">Deleting an entity</a></li>
    </ul>
  </li>
  <li><a href="#caching-custom-entities" class="scroll-to">Caching custom entities</a></li>
</ul>


          

          <h2 id="introduction">Introduction</h2>

<p>While not all plugins need it, your plugin might need to store more than
its configuration in the database. In that case, Kong provides you with
an abstraction on top of its primary datastores which allows you to store
custom entities.</p>

<p>As explained in the <a href="/1.0.x/plugin-development/access-the-datastore/">previous chapter</a>, Kong interacts
with the model layer through classes we refer to as “DAOs”, and available on a
singleton often referred to as the “DAO Factory”. This chapter will explain how
to to provide an abstraction for your own entities.</p>

<h2 id="modules">Modules</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kong.plugins.&lt;plugin_name&gt;.daos
kong.plugins.&lt;plugin_name&gt;.migrations.init
kong.plugins.&lt;plugin_name&gt;.migrations.000_base_&lt;plugin_name&gt;
kong.plugins.&lt;plugin_name&gt;.migrations.001_&lt;from-version&gt;_to_&lt;to_version&gt;
kong.plugins.&lt;plugin_name&gt;.migrations.002_&lt;from-version&gt;_to_&lt;to_version&gt;
</code></pre></div></div>

<h2 id="create-the-migrations-folder">Create the migrations folder</h2>

<p>Once you have defined your model, you must create your migration modules which
will be executed by Kong to create the table in which your records of your
entity will be stored.</p>

<p>If your plugin is intended to support both Cassandra and Postgres, then both
migrations must be written.</p>

<p>If your plugin doesn’t have it already, you should add a <code class="highlighter-rouge">&lt;plugin_name&gt;/migrations</code>
folder to it. If there is no <code class="highlighter-rouge">init.lua</code> file inside already, you should create one.
This is where all the migrations for your plugin will be referenced.</p>

<p>The initial version of your <code class="highlighter-rouge">migrations/init.lua</code> file will point to a single migration.</p>

<p>In this case we have called it <code class="highlighter-rouge">000_base_my_plugin</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- `migrations/init.lua`</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="s2">"000_base_my_plugin"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This means that there will be a file in <code class="highlighter-rouge">&lt;plugin_name&gt;/migrations/000_base_my_plugin.lua</code>
containing the initial migrations. We’ll see how this is done in a minute.</p>

<h2 id="adding-a-new-migration-to-an-existing-plugin">Adding a new migration to an existing plugin</h2>

<p>Sometimes it is necessary to introduce changes after a version of a plugin has already been
released. A new functionality might be needed. A database table row might need changing.</p>

<p>When this happens, <em>you must</em> create a new migrations file. You <em>must not</em> of modify the
existing migration files once they are published (you can still make them more robust and
bulletproof if you want, e.g. always try to write the migrations reentrant).</p>

<p>While there is no strict rule for naming your migration files, there is a convention that the
initial one is prefixed by <code class="highlighter-rouge">000</code>, the next one by <code class="highlighter-rouge">001</code>, and so on.</p>

<p>Following with our previous example, if we wanted to release a new version of the plugin with
changes in the database (for example, a table was needed called <code class="highlighter-rouge">foo</code>) we would insert it by
adding a file called <code class="highlighter-rouge">&lt;plugin_name&gt;/migrations/001_100_to_110.lua</code>, and referencing it on the
migrations init file like so (where <code class="highlighter-rouge">100</code> is the previous version of the plugin <code class="highlighter-rouge">1.0.0</code> and
<code class="highlighter-rouge">110</code> is the version to which plugin is migrated to <code class="highlighter-rouge">1.1.0</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- `&lt;plugin_name&gt;/migrations/init.lua`</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="s2">"000_base_my_plugin"</span><span class="p">,</span>
  <span class="s2">"001_100_to_110"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="migration-file-syntax">Migration File syntax</h2>

<p>While Kong’s core migrations support both Postgres and Cassandra, custom plugins
can choose to support either both of them or just one.</p>

<p>A migration file is a Lua file which returns a table with the following structure:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- `&lt;plugin_name&gt;/migrations/000_base_my_plugin.lua`</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="n">postgresql</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">up</span> <span class="o">=</span> <span class="s">[[
      CREATE TABLE IF NOT EXISTS "my_plugin_table" (
        "id"           UUID                         PRIMARY KEY,
        "created_at"   TIMESTAMP WITHOUT TIME ZONE,
        "col1"         TEXT
      );
    
      DO $$
      BEGIN
        CREATE INDEX IF NOT EXISTS "my_plugin_table_col1"
                                ON "my_plugin_table" ("col1");
      EXCEPTION WHEN UNDEFINED_COLUMN THEN
        -- Do nothing, accept existing state
      END$$;
    ]]</span><span class="p">,</span>
  <span class="p">},</span>

  <span class="n">cassandra</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">up</span> <span class="o">=</span> <span class="s">[[
      CREATE TABLE IF NOT EXISTS my_plugin_table (
        id          uuid PRIMARY KEY,
        created_at  timestamp,
        col1        text
      );
      
      CREATE INDEX IF NOT EXISTS ON my_plugin_table (col1);
    ]]</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- `&lt;plugin_name&gt;/migrations/001_100_to_110.lua`</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="n">postgresql</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">up</span> <span class="o">=</span> <span class="s">[[
      DO $$
      BEGIN
        ALTER TABLE IF EXISTS ONLY "my_plugin_table" ADD "cache_key" TEXT UNIQUE;
      EXCEPTION WHEN DUPLICATE_COLUMN THEN
        -- Do nothing, accept existing state
      END;
    $$;
    ]]</span><span class="p">,</span>
    <span class="n">teardown</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">helpers</span><span class="p">)</span>
      <span class="nb">assert</span><span class="p">(</span><span class="n">connector</span><span class="p">:</span><span class="n">connect_migrations</span><span class="p">())</span>
      <span class="nb">assert</span><span class="p">(</span><span class="n">connector</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="s">[[
        DO $$
        BEGIN
          ALTER TABLE IF EXISTS ONLY "my_plugin_table" DROP "col1";
        EXCEPTION WHEN UNDEFINED_COLUMN THEN
          -- Do nothing, accept existing state
        END$$;
      ]]</span><span class="p">)</span>
    <span class="k">end</span><span class="p">,</span>
  <span class="p">},</span>

  <span class="n">cassandra</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">up</span> <span class="o">=</span> <span class="s">[[
      ALTER TABLE my_plugin_table ADD cache_key text;
      CREATE INDEX IF NOT EXISTS ON my_plugin_table (cache_key);
    ]]</span><span class="p">,</span>
    <span class="n">teardown</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">helpers</span><span class="p">)</span>
      <span class="nb">assert</span><span class="p">(</span><span class="n">connector</span><span class="p">:</span><span class="n">connect_migrations</span><span class="p">())</span>
      <span class="nb">assert</span><span class="p">(</span><span class="n">connector</span><span class="p">:</span><span class="n">query</span><span class="p">(</span><span class="s2">"ALTER TABLE my_plugin_table DROP col1"</span><span class="p">))</span>
    <span class="k">end</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If a plugin only supports Postgres or Cassandra, only the section for one strategy is
needed. Each strategy section has two parts, <code class="highlighter-rouge">up</code> and <code class="highlighter-rouge">teardown</code>.</p>

<ul>
  <li><code class="highlighter-rouge">up</code> is an optional string of raw SQL/CQL statements. Those statements will be executed
when <code class="highlighter-rouge">kong migrations up</code> is executed.</li>
  <li><code class="highlighter-rouge">teardown</code> is an optional Lua function, which takes a <code class="highlighter-rouge">connector</code> parameter. Such connector
can invoke the <code class="highlighter-rouge">query</code> method to execute SQL/CQL queries. Teardown is triggered by
<code class="highlighter-rouge">kong migrations finish</code></li>
</ul>

<p>It is recommended that all the non-destructive operations, such as creation of new tables and
addition of new records is done on the <code class="highlighter-rouge">up</code> sections, while destructive operations (such as
removal of data, changing row types, insertion of new data) is done on the <code class="highlighter-rouge">teardown</code> sections.</p>

<p>In both cases, it is recommended that all the SQL/CQL statements are written so that they are
as reentrant as possible. <code class="highlighter-rouge">DROP TABLE IF EXISTS</code> instead of <code class="highlighter-rouge">DROP TABLE</code>,
<code class="highlighter-rouge">CREATE INDEX IF NOT EXIST</code> instead of <code class="highlighter-rouge">CREATE INDEX</code>, etc. If a migration fails for some
reason, it is expected that the first attempt at fixing the problem will be simply
re-running the migrations.</p>

<p>While Postgres does, Cassandra does not support constraints such as “NOT
NULL”, “UNIQUE” or “FOREIGN KEY”, but Kong provides you with such features when
you define your model’s schema. Bear in mind that this schema will be the same
for both Postgres and Cassandra, hence, you might trade-off a pure SQL schema
for one that works with Cassandra too.</p>

<p><strong>IMPORTANT</strong>: if your <code class="highlighter-rouge">schema</code> uses a <code class="highlighter-rouge">unique</code> constraint, then Kong will
enforce it for Cassandra, but for Postgres you must set this constraint in
the migrations.</p>

<p>To see a real-life example, give a look at the <a href="https://github.com/Kong/kong/tree/1.0.x/kong/plugins/key-auth/migrations">Key-Auth plugin migrations</a>.</p>

<hr />

<h2 id="defining-a-schema">Defining a Schema</h2>

<p>The first step to using custom entities in a custom plugin is defining one
or more <em>schemas</em>.</p>

<p>A schema is a Lua table which describes entities. There’s structural information
like how are the different fields of the entity named and what are their types,
which is similar to the fields describing your <a href="/1.0.x/plugin-development/plugin-configuration/">plugin
configuration</a>).
Compared to plugin configuration schemas, custom entity schemas require
additional metadata (e.g. which field, or fields, constitute the entities’
primary key).</p>

<p>Schemas are to be defined in a module named:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kong.plugins.&lt;plugin_name&gt;.daos
</code></pre></div></div>

<p>Meaning that there should be a file called <code class="highlighter-rouge">&lt;plugin_name&gt;/daos.lua</code> inside your
plugin folder. The <code class="highlighter-rouge">daos.lua</code> file should return a table containing one or more
schemas. For example:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- daos.lua</span>
<span class="kd">local</span> <span class="n">typedefs</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"kong.db.schema.typedefs"</span>


<span class="k">return</span> <span class="p">{</span>
  <span class="c1">-- this plugin only results in one custom DAO, named `keyauth_credentials`:</span>
  <span class="n">keyauth_credentials</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span>               <span class="o">=</span> <span class="s2">"keyauth_credentials"</span><span class="p">,</span> <span class="c1">-- the actual table in the database</span>
    <span class="n">endpoint_key</span>       <span class="o">=</span> <span class="s2">"key"</span><span class="p">,</span>
    <span class="n">primary_key</span>        <span class="o">=</span> <span class="p">{</span> <span class="s2">"id"</span> <span class="p">},</span>
    <span class="n">cache_key</span>          <span class="o">=</span> <span class="p">{</span> <span class="s2">"key"</span> <span class="p">},</span>
    <span class="n">generate_admin_api</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">{</span>
        <span class="c1">-- a value to be inserted by the DAO itself</span>
        <span class="c1">-- (think of serial id and the uniqueness of such required here)</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">typedefs</span><span class="p">.</span><span class="n">uuid</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="c1">-- also interted by the DAO itself</span>
        <span class="n">created_at</span> <span class="o">=</span> <span class="n">typedefs</span><span class="p">.</span><span class="n">auto_timestamp_s</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="c1">-- a foreign key to a consumer's id</span>
        <span class="n">consumer</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nb">type</span>      <span class="o">=</span> <span class="s2">"foreign"</span><span class="p">,</span>
          <span class="n">reference</span> <span class="o">=</span> <span class="s2">"consumers"</span><span class="p">,</span>
          <span class="n">default</span>   <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">null</span><span class="p">,</span>
          <span class="n">on_delete</span> <span class="o">=</span> <span class="s2">"cascade"</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="c1">-- a unique API key</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nb">type</span>      <span class="o">=</span> <span class="s2">"string"</span><span class="p">,</span>
          <span class="n">required</span>  <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
          <span class="n">unique</span>    <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
          <span class="n">auto</span>      <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This example <code class="highlighter-rouge">daos.lua</code> file introduces a single schema called <code class="highlighter-rouge">keyauth_credentials</code>.</p>

<p>Here is a description of some top-level properties:</p>

<table>
<tbody>
<tr><th>Name</th><th>Type</th><th>Description</th></tr>
<tr>
  <td><code>name</code></td>
  <td><code>string</code> (required)</td>
  <td>It will be used to determine the DAO name (<code>kong.db.[name]</code>).</td>
</tr>
<tr>
  <td><code>primary_key</code></td>
  <td><code>table</code> (required)</td>
  <td>
    Field names forming the entity's primary key.
    Schemas support composite keys, even if most Kong core entities currently use an UUID named
    <code>id</code>. If you are using Cassandra and need a composite key, it should have the same
    fields as the partition key.
  </td>
</tr>
<tr>
<td><code>endpoint_key</code></td>
  <td><code>string</code> (optional)</td>
  <td>
    The name of the field used as an alternative identifier on the Admin API.
    On the example above, <code>key</code> is the endpoint_key. This means that a credential with
    <code>id = 123</code> and <code>key = "foo"</code> could be referenced as both
    <code>/keyauth_credentials/123</code> and <code>/keyauth_credentials/foo</code>.
  </td>
</tr>
<tr>
  <td><code>cache_key</code></td>
  <td><code>table</code> (optional)</td>
  <td>
    Contains the name of the fields used for generating the <code>cache_key</code>, a string which must
    unequivocally identify the entity inside Kong's cache. A unique field, like <code>key</code> in your example,
    is usually good candidate. In other cases a combination of several fields is preferable.
  </td>
</tr>
<tr>
  <td><code>fields</code></td>
  <td><code>table</code></td>
  <td>
    Each field definition is a table with a single key, which is the field's name. The table value is
    a subtable containing the field's <em>attributes</em>, some of which will be explained below.
  </td>
</tr>
</tbody>
</table>

<p>Many field attributes encode <em>validation rules</em>. When attempting to insert or update entities using
the DAO, these validations will be checked, and an error returned if the provided input doesn’t conform
to them.</p>

<p>The <code class="highlighter-rouge">typedefs</code> variable (obtained by requiring <code class="highlighter-rouge">kong.db.schema.typedefs</code>) is a table containing
a lot of useful type definitions and aliases, including <code class="highlighter-rouge">typedefs.uuid</code>, the most usual type for the primary key,
and <code class="highlighter-rouge">typedefs.auto_timestamp_s</code>, for <code class="highlighter-rouge">created_at</code> fields. It is used extensively when defining fields.</p>

<p>Here’s a non-exhaustive explanation of some of the field attributes available:</p>

<table>
<tbody>
<tr><th>Attribute name</th><th>type</th><th>Description</th></tr>
<tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    Schemas support the following scalar types: <code>"string"</code>, <code>"integer"</code>, <code>"number"</code> and
    <code>"boolean"</code>. Compound types like <code>"array"</code>, <code>"record"</code>, or <code>"set"</code> are
    also supported.<br /><br />

    In additon to these values, the <code>type</code> attribute can also take the special <code>"foreign"</code> value,
    which denotes a foreign relationship.<br /><br />

    Each field will need to be backed by database fields of appropriately similar types, created via migrations.<br /><br />

    <code>type</code> is the only required attribute for all field definitions.
  </td>
</tr>
<tr>
  <td><code>default</code></td>
  <td><code>any</code> (matching with <code>type</code> attribute)</td>
  <td>
    Specifies the value the field will have when attempting to insert it, if no value was provided.
    Default values are always set via Lua, never by the underlying database. It is thus not recommended to set
    any default values on fields in migrations.
  </td>
</tr>
<tr>
  <td><code>required</code></td>
  <td><code>boolean</code></td>
  <td>
    When set to <code>true</code> on a field, an error will be thrown when attempting to insert an entity lacking a value
    for said field (unless the field in question has a default value).
  </td>
</tr>
<tr>
  <td><code>unique</code></td>
  <td><code>boolean</code></td>
  <td>
  <p>When set to <code>true</code> on a field, an error will be thrown when attempting to insert an entity on the database,
    but another entity already has the given value on said field.</p>

  <p>This attribute <em>must</em> be backed up by declaring fields as <code>UNIQUE</code> in migrations when using
    PostgreSQL. The Cassandra strategy does a check in Lua before attempting inserts, so it doesn't require any special treatment.
  </p>
  </td>
</tr>
<tr>
  <td><code>auto</code></td>
  <td><code>boolean</code></td>
  <td>
  When attempting to insert an entity without providing a value for this a field where <code>auto</code> is set to <code>true</code>,
  <br /><br />
  <ul>
    <li>If <code>type == "uuid"</code>, the field will take a random UUID as value.</li>
    <li>If <code>type == "string"</code>, the field will take a random string.</li>
    <li>If the field name is <code>created_at</code> or <code>updated_at</code>, the field will take the current time when
    inserting / updating, as appropriate.</li>
  </ul>
  </td>
</tr>
<tr>
  <td><code>reference</code></td>
  <td><code>string</code></td>
  <td>Required for fields of type <code>foreign</code>. The given string <em>must</em> be the name of an existing schema,
    to which the foreign key will "point to". This means that if a schema B has a foreign key pointing to schema A,
    then A needs to be loaded before B.
  </td>
</tr>
<tr>
  <td><code>on_delete</code></td>
  <td><code>string</code></td>
  <td>
    Optional and exclusive for fields of type <code>foreign</code>. It dictates what must happen
    with entities linked by a foreign key when the entity being referenced is deleted. It can have three possible
    values:<br /><br />

    <ul>
      <li><code>"cascade"</code>: When the linked entity is deleted, all the dependent entities must also be deleted.</li>
      <li><code>"null"</code>: When the linked entity is deleted, all the dependent entities will have their foreign key
      field set to <code>null</code>.</li>
      <li><code>"restrict"</code>: Attempting to delete an entity with linked entities will result in an error.</li>
    </ul>

    <br /><br />
    In Cassandra this is handled with pure Lua code, but in PostgreSQL it will be necessary to declare the references
    as <code>ON DELETE CASCADE/NULL/RESTRICT</code> in a migration.
  </td>
</tr>
</tbody>
</table>

<p>To learn more about schemas, see:</p>

<ul>
  <li>The source code of <a href="https://github.com/Kong/kong/blob/1.0.0/kong/db/schema/typedefs.lua">typedefs.lua</a>
to get an idea of what’s provided there by default.</li>
  <li><a href="https://github.com/Kong/kong/tree/1.0.0/kong/db/schema/entities">The Core Schemas</a>
to see examples of some other field attributes not discussed here.</li>
  <li><a href="https://github.com/search?utf8=%E2%9C%93&amp;q=repo%3Akong%2Fkong+path%3A%2Fkong%2Fplugins+filename%3Adaos.lua">All the <code class="highlighter-rouge">daos.lua</code> files for embedded plugins</a>,
especially <a href="https://github.com/Kong/kong/blob/1.0.0/kong/plugins/key-auth/daos.lua">the key-auth one</a>,
which was used for this guide as an example.</li>
</ul>

<hr />

<h2 id="the-custom-dao">The custom DAO</h2>

<p>The schemas are not used directly to interact with the database. Instead, a DAO
is built for each valid schema. A DAO takes the name of the schema it wraps, and is
accessible through the <code class="highlighter-rouge">kong.db</code> interface.</p>

<p>For the example schema above, the DAO generated would be available for plugins
via <code class="highlighter-rouge">kong.db.keyauth_credentials</code>.</p>

<h3 id="selecting-an-entity">Selecting an entity</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>
</code></pre></div></div>

<p>Attempts to find an entity in the database and return it. Three things can happen:</p>

<ul>
  <li>The entity was found. In this case, it is returned as a regular Lua table.</li>
  <li>An error occurred - for example the connection with the database was lost. In that
case the first returned value will be <code class="highlighter-rouge">nil</code>, the second one will be a string
describing the error, and the last one will be the same error in table form.</li>
  <li>An error does not occur but the entity is not found. Then the function will
just return <code class="highlighter-rouge">nil</code>, with no error.</li>
</ul>

<p>Example of usage:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span>
  <span class="n">id</span> <span class="o">=</span> <span class="s2">"c77c50d2-5947-4904-9f37-fa36182a71a9"</span>
<span class="p">})</span>

<span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when inserting keyauth credential: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Could not find credential."</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="iterating-over-all-the-entities">Iterating over all the entities</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="n">on</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="n">each</span><span class="p">(</span><span class="n">entities_per_page</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
    <span class="o">...</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This method efficiently iterates over all the entities in the database by making paginated
requests. The <code class="highlighter-rouge">entities_per_page</code> parameter, which defaults to <code class="highlighter-rouge">100</code>, controls how many
entities per page are returned.</p>

<p>On each iteration, a new <code class="highlighter-rouge">entity</code> will be returned or, if there is any error, the <code class="highlighter-rouge">err</code>
variable will be filled up with an error. The recommended way to iterate is checking <code class="highlighter-rouge">err</code> first,
and otherwise assume that <code class="highlighter-rouge">entity</code> is present.</p>

<p>Example of usage:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">credential</span><span class="p">,</span> <span class="n">err</span> <span class="n">on</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">each</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">err</span> <span class="k">then</span>
    <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when iterating over keyauth credentials: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>

  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s2">"id: "</span> <span class="o">..</span> <span class="n">credential</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This example iterates over the credentials in pages of 1000 items, logging their ids unless
an error happens.</p>

<h3 id="inserting-an-entity">Inserting an entity</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="o">&lt;</span><span class="n">values</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>Inserts an entity in the database, and returns a copy of the inserted entity, or
<code class="highlighter-rouge">nil</code>, an error message (a string) and a table describing the error in table form.</p>

<p>When the insert is successful, the returned entity contains the extra values produced by
<code class="highlighter-rouge">default</code> and <code class="highlighter-rouge">auto</code>.</p>

<p>The following example uses the <code class="highlighter-rouge">keyauth_credentials</code> DAO to insert a credential for a given
Consumer, setting its <code class="highlighter-rouge">key</code> to <code class="highlighter-rouge">"secret"</code>. Notice the syntax for referencing foreign keys.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">insert</span><span class="p">({</span>
  <span class="n">consumer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s2">"c77c50d2-5947-4904-9f37-fa36182a71a9"</span> <span class="p">},</span>
  <span class="n">key</span> <span class="o">=</span> <span class="s2">"secret"</span><span class="p">,</span>
<span class="p">})</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when inserting keyauth credential: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The returned entity, assuming no error happened will have <code class="highlighter-rouge">auto</code>-filled fields, like <code class="highlighter-rouge">id</code> and <code class="highlighter-rouge">created_at</code>.</p>

<h3 id="updating-an-entity">Updating an entity</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">values</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>Updates an existing entity, provided it can be found using the provided primary key and a set of values.</p>

<p>The returned entity will be the entity after the update takes place, or <code class="highlighter-rouge">nil</code> + an error message + an error table.</p>

<p>The following example modifies the <code class="highlighter-rouge">key</code> field of an existing credential given the credential’s id:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">update</span><span class="p">({</span>
  <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s2">"2b6a2022-770a-49df-874d-11e2bf2634f5"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">"updated_secret"</span> <span class="p">},</span>
<span class="p">})</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when updating keyauth credential: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Notice how the syntax for specifying a primary key is similar to the one used to specify a foreign key.</p>

<h3 id="upserting-an-entity">Upserting an entity</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="n">upsert</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">values</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">upsert</code> is a mixture of <code class="highlighter-rouge">insert</code> and <code class="highlighter-rouge">update</code>:</p>

<ul>
  <li>When the provided <code class="highlighter-rouge">primary_key</code> identifies an existing entity, it works like <code class="highlighter-rouge">update</code>.</li>
  <li>When the provided <code class="highlighter-rouge">primary_key</code> does not identify an existing entity, it works like <code class="highlighter-rouge">insert</code></li>
</ul>

<p>Given this code:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">entity</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">upsert</span><span class="p">({</span>
  <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s2">"2b6a2022-770a-49df-874d-11e2bf2634f5"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">consumer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s2">"a96145fb-d71e-4c88-8a5a-2c8b1947534c"</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">})</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when upserting keyauth credential: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Two things can happen:</p>

<ul>
  <li>If a credential with id <code class="highlighter-rouge">2b6a2022-770a-49df-874d-11e2bf2634f5</code> exists,
then this code will attempt to set its Consumer to the provided one.</li>
  <li>If the credential does not exist, then this code is attempting to create
a new credential, with the given id and Consumer.</li>
</ul>

<h3 id="deleting-an-entity">Deleting an entity</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_t</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>
</code></pre></div></div>

<p>Attempts to delete the entity identified by <code class="highlighter-rouge">primary_key</code>. It returns <code class="highlighter-rouge">true</code>
if the entity <em>doesn’t exist</em> after calling this method, or <code class="highlighter-rouge">nil</code> + error +
error table if an error is detected.</p>

<p>Notice that calling <code class="highlighter-rouge">delete</code> will succeed if the entity didn’t exist <em>before
calling it</em>. This is for performance reasons - we want to avoid doing a
read-before-delete if we can avoid it. If you want to do this check, you
must do it manually, by checking with <code class="highlighter-rouge">select</code> before invoking <code class="highlighter-rouge">delete</code>.</p>

<p>Example:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kong</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">keyauth_credentials</span><span class="p">:</span><span class="n">delete</span><span class="p">({</span>
  <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s2">"2b6a2022-770a-49df-874d-11e2bf2634f5"</span> <span class="p">}</span>
<span class="p">})</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="k">then</span>
  <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="s2">"Error when deleting keyauth credential: "</span> <span class="o">..</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="k">end</span>
</code></pre></div></div>

<hr />

<h2 id="caching-custom-entities">Caching custom entities</h2>

<p>Sometimes custom entities are required on every request/response, which in turn
triggers a query on the datastore every time. This is very inefficient because
querying the datastore adds latency and slows the request/response down, and
the resulting increased load on the datastore could affect the datastore
performance itself and, in turn, other Kong nodes.</p>

<p>When a custom entity is required on every request/response it is good practice
to cache it in-memory by leveraging the in-memory cache API provided by Kong.</p>

<p>The next chapter will focus on caching custom entities, and invalidating them
when they change in the datastore: <a href="/1.0.x/plugin-development/entities-cache/">Caching custom entities</a>.</p>

<hr />

<p>Next: <a href="/1.0.x/plugin-development/entities-cache/">Caching custom entities ›</a></p>



        </div>
      </div>
    </div>
  </div>
</div>
<style>
  @media (max-width: 768px) {
    .algolia-docsearch-suggestion--subcategory-column{
      display: none !important;
    }
  }
</style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>


<script type="text/javascript">
  docsearch({
    apiKey: '691286ef280379144076a4f8df47a1d1',
    indexName: 'getkong',
    inputSelector: '#getkong-algolia-search-input',
    algoliaOptions: {
      hitsPerPage: 5,
      'facetFilters': ["version: 1.0.x"]
    },
    // Override selected event to allow for local environment navigation
    handleSelected: function (input, event, suggestion) {
      input.setVal('');
      window.location.href = window.location.protocol + "//" + window.location.host + suggestion.url.split(
        "docs.konghq.com")[1]
    }
    // ,debug: true // Set debug to true if you want to inspect the dropdown
  });
</script>





    
<footer class="marketing-footer--light-gray">
  <section>
    <ul class="newsletter">
      <li class="logo-wrapper">
        <div class="logo">
          <img src="/assets/images/Kogo-gradient.svg" alt="Kong" />
        </div>
        <div class="form">
            <iframe src="https://go.konghq.com/l/392112/2019-02-14/bhxq9c" width="100%" height="60" type="text/html" frameborder="0" allowTransparency="true" style="border: 0"></iframe>
        </div>
        <div class="social">

          <div class="social-link">
            <a href="https://www.facebook.com/konghq/" title="Facebook"
              ><i
                aria-label="Facebook"
                class="fa fa-facebook-official"
                aria-hidden="true"
              ></i
            ></a>
          </div>
          <div class="social-link">
            <a href="https://twitter.com/thekonginc" title="Twitter"
              ><i
                aria-label="Twitter"
                class="fa fa-twitter"
                aria-hidden="true"
              ></i
            ></a>
          </div>
          <div class="social-link">
            <a href="https://www.meetup.com/topics/kong/all/" title="Meetup"
              ><i
              aria-label="Meetup"
              class="fa fa-meetup"
              aria-hidden="true"
            ></i
          ></a>
          </div>
          <div class="social-link">
            <a href="https://linkedin.com/company/278819" title="LinkedIn"
              ><i aria-label="GitHub" class="fa fa-linkedin" aria-hidden="true"></i
            ></a>
          </div>
          <div class="social-link">
            <a href="https://github.com/kong/kong" target="blank" class="btn-gh">
              <i class="fa fa-github" aria-hidden="true" aria-label="GitHub"></i> Star
            </a>
          </div>
        </div>
      </li>
      <li>
        <nav>
          <h5>Products</h5>
          <ul>
            <li><a href="http://konghq.com/kong/">Kong</a></li>
            <li><a href="http://konghq.com/kong-enterprise/">Kong Enterprise</a></li>
            <li><a href="http://konghq.com/cloud/">Kong Cloud</a></li>
            <li><a href="http://konghq.com/subscriptions/">Subscriptions</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h5>Resources</h5>
          <ul>
            <li>
              <a href="https://support.konghq.com" target="blank"
                >Enterprise Support</a
              >
            </li>
            <li>
              <a href="https://docs.konghq.com">Documentation</a>
            </li>
            <li><a href="http://konghq.com/partners/">Partners</a></li>
            <li><a href="http://konghq.com/webinars/">Webinars</a></li>
            <li><a href="http://konghq.com/ebooks/">Ebooks</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h5>Company</h5>
          <ul>
            <li><a href="http://konghq.com/about-kong-inc/">About</a></li>
            <li><a href="http://konghq.com/customers/">Customers</a></li>
            <li><a href="http://konghq.com/investors/">Investors</a></li>
            <li><a href="http://konghq.com/blog/">News</a></li>
            <li>
              <a href="http://konghq.com/careers/">Careers <span>Hiring!</span></a>
            </li>
            <li><a href="http://konghq.com/kong-summit/">Kong Summit</a></li>
            <li><a href="http://konghq.com/contact/">Contact</a></li>
          </ul>
        </nav>
      </li>
      <li>
        <nav>
          <h5>Open Source</h5>
          <ul>
            <li><a href="http://konghq.com/install/">Install</a></li>
            <li><a target="blank" href="https://github.com/Kong/">GitHub</a></li>
            <li><a href="https://discuss.konghq.com/"">Kong Nation</a></li>
            <li><a href="http://konghq.com/community/">Community</a></li>
          </ul>
        </nav>
      </li>
    </ul>
  </section>

  <section class="legal">
    <ul>
      <li>
        <span class="mashape-footer-content">&copy; Kong Inc. 2019 &nbsp; <a href="http://konghq.com/terms/">Terms</a><b>•</b><a href="http://konghq.com/privacy/">Privacy</a></span>
      </li>
    </ul>
  </section>

  <script type="text/javascript">
    function onSubmit(response) {
      document.getElementById('subscription_form').submit();
      document.getElementById('follow_up_subscription_form').submit();
      if (response.length == 0) {
        alert('reCaptcha verification failed');
      }
    }
  </script>
</footer>
 <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var className =
        ".show-anchor-links h1, .show-anchor-links h2, .show-anchor-links h3, " +
        ".show-anchor-links h4, .show-anchor-links h5, .show-anchor-links h6";
      var headers = document.querySelectorAll(className);

      for (var i = 0; i < headers.length; i++) {
        var header = headers[i];
        if (typeof header.id !== "undefined" && header.id !== "") {
          header.prepend(anchorForId(header.id));
        }
      }
    }
  };
</script>


    <script src="/assets/app.js?v=1573061372"></script>

    <div id="fb-root"></div>

    <script
      src="https://2tjosk2rxzc21medji3nfn1g-wpengine.netdna-ssl.com/wp-content/themes/konghq/assets/js/vendor/bootstrap.min.js"
      async
      defer
    ></script>

    <script
      id="github-bjs"
      src="https://buttons.github.io/buttons.js"
      async
      defer
    ></script>
    <script
      id="twitter-wjs"
      type="text/javascript"
      src="https://platform.twitter.com/widgets.js"
      async
      defer
    ></script>
    <script
      id="facebook-jssdk"
      type="text/javascript"
      src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=842731852424506"
      async
      defer
    ></script>

    <script type="text/javascript">
      piAId = '393112';
      piCId = '48375';

      (function() {
        function async_load() {
          var s = document.createElement('script');
          s.type = 'text/javascript';
          s.src =
            ('https:' == document.location.protocol
              ? 'https://pi'
              : 'http://cdn') + '.pardot.com/pd.js';
          var c = document.getElementsByTagName('script')[0];
          c.parentNode.insertBefore(s, c);
        }
        if (window.attachEvent) {
          window.attachEvent('onload', async_load);
        } else {
          window.addEventListener('load', async_load, false);
        }
      })();
    </script>

    <script type="text/javascript">
      var _vwo_code = (function() {
        var account_id = 125292,
          settings_tolerance = 2000,
          library_tolerance = 2500,
          use_existing_jquery = true,
          // DO NOT EDIT BELOW THIS LINE
          f = false,
          d = document;
        return {
          use_existing_jquery: function() {
            return use_existing_jquery;
          },
          library_tolerance: function() {
            return library_tolerance;
          },
          finish: function() {
            if (!f) {
              f = true;
              var a = d.getElementById('_vis_opt_path_hides');
              if (a) a.parentNode.removeChild(a);
            }
          },
          finished: function() {
            return f;
          },
          load: function(a) {
            var b = d.createElement('script');
            b.src = a;
            b.type = 'text/javascript';
            b.innerText;
            b.onerror = function() {
              _vwo_code.finish();
            };
            d.getElementsByTagName('head')[0].appendChild(b);
          },
          init: function() {
            settings_timer = setTimeout(
              '_vwo_code.finish()',
              settings_tolerance
            );
            this.load(
              '//dev.visualwebsiteoptimizer.com/j.php?a=' +
                account_id +
                '&u=' +
                encodeURIComponent(d.URL) +
                '&r=' +
                Math.random()
            );
            var a = d.createElement('style'),
              b = '',
              h = d.getElementsByTagName('head')[0];
            a.setAttribute('id', '_vis_opt_path_hides');
            a.setAttribute('type', 'text/css');
            if (a.styleSheet) a.styleSheet.cssText = b;
            else a.appendChild(d.createTextNode(b));
            h.appendChild(a);
            return settings_timer;
          }
        };
      })();
      _vwo_settings_timer = _vwo_code.init();
    </script>

    <script type="text/javascript">
      !(function() {
        var analytics = (window.analytics = window.analytics || []);
        if (!analytics.initialize)
          if (analytics.invoked)
            window.console &&
              console.error &&
              console.error('Segment snippet included twice.');
          else {
            analytics.invoked = !0;
            analytics.methods = [
              'trackSubmit',
              'trackClick',
              'trackLink',
              'trackForm',
              'pageview',
              'identify',
              'group',
              'track',
              'ready',
              'alias',
              'page',
              'once',
              'off',
              'on'
            ];
            analytics.factory = function(t) {
              return function() {
                var e = Array.prototype.slice.call(arguments);
                e.unshift(t);
                analytics.push(e);
                return analytics;
              };
            };
            for (var t = 0; t < analytics.methods.length; t++) {
              var e = analytics.methods[t];
              analytics[e] = analytics.factory(e);
            }
            analytics.load = function(t) {
              var e = document.createElement('script');
              e.type = 'text/javascript';
              e.async = !0;
              e.src =
                ('https:' === document.location.protocol
                  ? 'https://'
                  : 'http://') +
                'cdn.segment.com/analytics.js/v1/' +
                t +
                '/analytics.min.js';
              var n = document.getElementsByTagName('script')[0];
              n.parentNode.insertBefore(e, n);
            };
            analytics.SNIPPET_VERSION = '3.0.1';
            analytics.load('WDj0nSS7hpyxwL3evgbOzK755s0NUye6');
            analytics.page();
          }
      })();
    </script>

    <script>
      // Collapse Toggler
      $('button[data-toggle="kong-expand"]').on('click', function(e) {
        e.stopPropagation();
        var $this = $(this);
        $('#oss_subnav.expand').toggleClass('slideup');
        $($this.data('target')).toggleClass('kong-navbar-collapse--expand');
        $('nav.navbar.full-width').toggleClass('kong-navbar-collapse--expand');
        $this.toggleClass('active').attr('aria-expanded', true);
        $('.kong-navbar-collapse_section').removeClass('shift');
        $('.subnav, .trigger, .remove').removeClass('active');
        setTimeout(function() {
          $('#menu-primary-nav li').removeClass('active');
          $('.active-tab').removeClass('active-tab');
        }, 100);
      });

      var $window = $(window);

      function checkWidth() {
        var windowsize = $window.width();
        if (windowsize > 1080) {
          $('.navbar').removeClass('mobile-triggers');
          $('#menu-primary-nav li').removeClass('active');
          $('.active-tab').removeClass('active-tab');
        } else {
          $('.navbar').addClass('mobile-triggers');
        }
      }
      // Execute on load
      checkWidth();
      // Bind event listener
      $(window).resize(checkWidth);

      $('#menu-primary-nav .nav1 > a').click(function() {
        if ($('nav.navbar').hasClass('mobile-triggers')) {
          event.preventDefault();
          $('.nav3').removeClass('active');
          var position = $(this)
            .parent()
            .position();
          $(this)
            .parent()
            .toggleClass('active');
          $('body')
            .get(0)
            .style.setProperty(
              '--navPosition',
              (position.top - 75) * -1 + 'px'
            );
          $(this)
            .parent()
            .parent()
            .toggleClass('active-tab');
        }
      });

      $('#menu-primary-nav .nav3 > a').click(function() {
        if ($('nav.navbar').hasClass('mobile-triggers')) {
          event.preventDefault();
          $(this)
            .parent()
            .toggleClass('active');
        }
      });
    </script>
  </body>

  
</html>
